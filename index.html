<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="forum-title-tag">Negativa Server - Fórum</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .view { display: none; } /* Helper class to manage views */
        .active-view { display: block; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .modal {
            position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%;
            overflow: auto; background-color: rgba(0,0,0,0.5); display: flex;
            align-items: center; justify-content: center;
        }
        .modal-content {
            background-color: #fefefe; color: #333; margin: auto; padding: 20px;
            border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 8px;
        }
        .modal-content-lg {
             max-width: 700px;
        }
        .modal-close {
            color: #aaa; float: right; font-size: 28px; font-weight: bold;
        }
        .modal-close:hover, .modal-close:focus {
            color: black; text-decoration: none; cursor: pointer;
        }
        .loading-spinner, .gemini-loading-spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid #3498db;
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite; margin: 20px auto;
        }
        .gemini-loading-spinner {
            width: 20px; height: 20px; border-width: 3px; display: inline-block;
            margin: 0 0 0 10px; vertical-align: middle;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .role-tag {
            padding: 0.1em 0.4em;
            border-radius: 0.25em;
            font-size: 0.75em;
            font-weight: bold;
            margin-left: 0.5em;
            color: white;
            background-color: #6b7280; /* Default color */
        }
        #chat-messages {
            height: 200px;
            overflow-y: auto;
            border: 1px solid #4a5568;
            padding: 8px;
            border-radius: 0.375rem;
            margin-bottom: 8px;
            background-color: #2d3748;
        }
        .chat-message {
            margin-bottom: 4px;
            padding: 4px;
            border-radius: 0.25rem;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        .chat-message .username {
            font-weight: bold;
        }
        .chat-message .delete-chat-msg-btn {
            background: none;
            border: none;
            color: #f56565;
            cursor: pointer;
            font-size: 0.75rem;
            padding: 0 0.25rem;
            margin-left: 0.5rem;
        }
        .chat-message .delete-chat-msg-btn:hover {
            color: #c53030;
        }
         /* Toggle Switch Styles */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #4CAF50;
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        /* Admin Panel Section Styling */
        .admin-section {
            background-color: rgba(42, 50, 66, 0.5); 
            padding: 1.5rem; 
            border-radius: 0.5rem; 
            margin-bottom: 1.5rem; 
            border: 1px solid #4a5568; 
        }
        .admin-section-title {
            font-size: 1.125rem; 
            font-weight: 600; 
            color: #facc15; 
            margin-bottom: 1rem; 
            padding-bottom: 0.5rem; 
            border-bottom: 1px solid #4a5568; 
        }
        #admin-controls { 
            display: none;
        }
        .edit-topic-btn-icon {
            cursor: pointer;
            margin-left: 8px;
            color: #fbbf24; /* amber-400 */
        }
        .edit-topic-btn-icon:hover {
            color: #f59e0b; /* amber-500 */
        }

    </style>
</head>
<body class="bg-gray-900 text-gray-100">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            signInWithCustomToken
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            collection,
            addDoc,
            getDocs,
            doc,
            getDoc,
            setDoc,
            query,
            where,
            Timestamp,
            onSnapshot,
            deleteDoc,
            updateDoc,
            increment,
            orderBy,
            limit,
            runTransaction,
            setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const userHardcodedFirebaseConfig = {
          apiKey: "AIzaSyCFqjQc4lEj8-djp7frombN_isi_3DVnCM", 
          authDomain: "negativa-af3a2.firebaseapp.com",
          projectId: "negativa-af3a2",
          storageBucket: "negativa-af3a2.appspot.com",
          messagingSenderId: "448951636288",
          appId: "1:448951636288:web:60d1ebb08fcd5b246aaaa5",
          measurementId: "G-GPG4L7TZVE"
        };

        let activeFirebaseConfig = userHardcodedFirebaseConfig;
        let finalInitialAuthToken = undefined;

        const canvasProvidedFirebaseConfigStr = (typeof __firebase_config !== 'undefined' && __firebase_config !== null && String(__firebase_config).trim() !== "" && String(__firebase_config) !== "{}")
            ? String(__firebase_config)
            : null;

        const canvasProvidedInitialAuthToken = (typeof __initial_auth_token !== 'undefined' && __initial_auth_token !== null && String(__initial_auth_token).toLowerCase() !== "undefined" && String(__initial_auth_token).trim() !== "")
            ? String(__initial_auth_token)
            : undefined;

        if (canvasProvidedFirebaseConfigStr && canvasProvidedInitialAuthToken) {
            try {
                activeFirebaseConfig = JSON.parse(canvasProvidedFirebaseConfigStr);
                finalInitialAuthToken = canvasProvidedInitialAuthToken;
                console.log("Using Firebase config and auth token provided by Canvas environment.");
            } catch (e) {
                console.error("Error parsing Canvas-provided Firebase config. Falling back to user's hardcoded config. Custom token from Canvas will NOT be used.", e);
                activeFirebaseConfig = userHardcodedFirebaseConfig;
                finalInitialAuthToken = undefined;
            }
        } else if (canvasProvidedInitialAuthToken) {
            console.warn("Canvas custom token detected, but no valid Canvas Firebase config. Using user's hardcoded Firebase config. Canvas token will NOT be used to prevent mismatch.");
            activeFirebaseConfig = userHardcodedFirebaseConfig;
            finalInitialAuthToken = undefined;
        } else {
            console.log("Using user's hardcoded Firebase config. No Canvas custom token or config detected.");
            activeFirebaseConfig = userHardcodedFirebaseConfig;
            finalInitialAuthToken = undefined;
        }
        
        const firestorePathAppId = (typeof __app_id !== 'undefined' && String(__app_id).trim() !== "") ? String(__app_id) : activeFirebaseConfig.projectId;
        console.log("Using Firestore Path App ID for Firestore paths:", firestorePathAppId);
        
        let app;
        let auth;
        let db;

        try {
            app = initializeApp(activeFirebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            setLogLevel('debug'); 
            console.log("Firebase initialized successfully. Firestore debug logging enabled.");
        } catch (e) {
            console.error("CRITICAL: Firebase initialization failed:", e);
            const errorModal = document.getElementById('message-modal');
            const errorModalText = document.getElementById('message-modal-text');
            if (errorModal && errorModalText) {
                errorModalText.textContent = "Falha crítica na inicialização do Firebase: " + e.message + ". O aplicativo pode não funcionar corretamente.";
                errorModalText.className = 'mb-4 text-red-700';
                errorModal.style.display = 'flex';
            } else {
                console.error("Fallback Alert: Falha crítica na inicialização do Firebase: " + e.message);
            }
        }

        let currentUser = null;
        let currentUserId = null;
        let isAdmin = false;
        let userProfileData = null; 
        let currentRolePermissions = {}; 

        let unsubscribeCategories = null;
        let unsubscribeTopics = null;
        let unsubscribePosts = null;
        let unsubscribeServerConfig = null;
        let unsubscribeRecentMembers = null;
        let unsubscribeChatMessages = null;
        let unsubscribeCurrentUserProfile = null; 
        
        let editingPostId = null; // For editing post content
        let editingTopicId = null; // For editing topic metadata (title, roles)
        let editingTopicData = null; // To store current topic data for the edit modal


        const PERMISSIONS = {
            MANAGE_FORUM_SETTINGS: 'canManageForumSettings',
            MANAGE_USERS: 'canManageUsers',
            MANAGE_CATEGORIES: 'canManageCategories',
            CREATE_TOPIC: 'canCreateTopic',
            DELETE_OWN_TOPIC: 'canDeleteOwnTopic',
            DELETE_ANY_TOPIC: 'canDeleteAnyTopic',
            CREATE_POST: 'canCreatePost',
            EDIT_OWN_POST: 'canEditOwnPost',
            EDIT_ANY_POST: 'canEditAnyPost',
            DELETE_OWN_POST: 'canDeleteOwnPost',
            DELETE_ANY_POST: 'canDeleteAnyPost',
            MODERATE_CHAT: 'canModerateChat',
            MANAGE_ROLES_PERMISSIONS: 'canManageRolesPermissions'
            // Consider adding EDIT_ANY_TOPIC if more granular control is needed than MANAGE_CATEGORIES
        };

        const defaultRoles = ['Admin', 'Moderador', 'VIP', 'Membro'];
        let currentRoleColors = {}; 
        let serverRolePermissionsConfig = {}; 
        let registrationsOpen = true; 

        const views = {}; 
        let forumTitleHeader, forumTitleTag, userDisplay, loginNav, registerNav, logoutNav, myProfileNav, adminControls, adminPanelNav,
            categoriesList, topicsList, postsList, categoryTitle, topicTitleFull, breadcrumbs, currentUserIdDisplay,
            adminUserList, generateCategoryDescBtn, categoryNameInput, categoryDescriptionInput, suggestTopicTitleBtn,
            newTopicContentInput, newTopicTitleInput, newTopicCommandInput, myProfileNicknameInput, myProfileSteamUrlInput,
            myProfileEmailDisplay, myProfileRoleDisplay, myProfileSaveBtn, userProfileViewDisplayName, userProfileViewNickname,
            userProfileViewEmail, userProfileViewRole, userProfileViewSteamLink, userProfileViewRegisteredDate,
            adminRoleColorSettings, saveRoleColorsBtn, adminForumNameInput, saveForumNameBtn, adminRegistrationsToggle,
            saveRegistrationSettingsBtn, csServersListAdmin, addCsServerBtn, csServerModal, csServerForm, csServerIdInput,
            csServerNameInput, csServerConnectInput, cancelCsServerBtn, serverInfoBannerContainer, recentMembersList,
            editPostModal, editPostContentInput, saveEditPostBtn, cancelEditPostBtn, chatMessagesContainer,
            chatMessageInput, sendChatMessageBtn, backToForumFromProfileBtn, adminPermissionsSettings, savePermissionsBtn,
            categoryRolePermissionsAdminContainer, topicRolePermissionsContainer, editTopicModal, editTopicTitleInput, 
            editTopicRolePermissionsContainer, saveEditTopicBtn, cancelEditTopicBtn;


        function formatTimestamp(firebaseTimestamp) {
            if (!firebaseTimestamp || typeof firebaseTimestamp.seconds !== 'number') {
                return 'Data inválida';
            }
            const date = new Date(firebaseTimestamp.seconds * 1000);
            const now = new Date();
            const diffInSeconds = Math.floor((now.getTime() - date.getTime()) / 1000);

            if (diffInSeconds < 0) return `em breve`; 
            if (diffInSeconds < 60) return `há ${diffInSeconds} seg`;
            const diffInMinutes = Math.floor(diffInSeconds / 60);
            if (diffInMinutes < 60) return `há ${diffInMinutes} min`;
            const diffInHours = Math.floor(diffInMinutes / 60);
            if (diffInHours < 24) return `há ${diffInHours} h`;

            const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
            return date.toLocaleDateString('pt-BR', options);
        }

        function hasPermission(permissionKey) {
            if (!userProfileData || !userProfileData.role) {
                return false;
            }
            if (userProfileData.role === 'Admin') { 
                return true;
            }
            const rolePerms = serverRolePermissionsConfig[userProfileData.role];
            return rolePerms && rolePerms[permissionKey] === true;
        }

        function showView(viewName, params = null) {
            Object.values(views).forEach(view => view.classList.remove('active-view'));
            if (views[viewName]) {
                views[viewName].classList.add('active-view');
                if (viewName === 'userProfile' && params && params.userId) {
                    loadUserProfileView(params.userId);
                } else if (viewName === 'myProfile') {
                    loadMyProfileView();
                }
            } else {
                console.error(`View ${viewName} not found. Defaulting to login or forum home.`);
                if (currentUser && views.forumHome) views.forumHome.classList.add('active-view');
                else if (views.login) views.login.classList.add('active-view');
            }
            window.scrollTo(0, 0);
        }
        
        function populateDomElementVariables() {
            views.loading = document.getElementById('loading-view');
            views.login = document.getElementById('login-view');
            views.register = document.getElementById('register-view');
            views.forumHome = document.getElementById('forum-home-view');
            views.category = document.getElementById('category-view');
            views.topic = document.getElementById('topic-view');
            views.myProfile = document.getElementById('my-profile-view');
            views.userProfile = document.getElementById('user-profile-view');

            forumTitleHeader = document.getElementById('forum-title-header');
            forumTitleTag = document.getElementById('forum-title-tag');
            userDisplay = document.getElementById('user-display');
            loginNav = document.getElementById('login-nav');
            registerNav = document.getElementById('register-nav');
            logoutNav = document.getElementById('logout-nav');
            myProfileNav = document.getElementById('my-profile-nav');
            adminControls = document.getElementById('admin-controls');
            adminPanelNav = document.getElementById('admin-panel-nav'); 
            categoriesList = document.getElementById('categories-list');
            topicsList = document.getElementById('topics-list');
            postsList = document.getElementById('posts-list');
            categoryTitle = document.getElementById('category-title');
            topicTitleFull = document.getElementById('topic-title-full');
            breadcrumbs = document.getElementById('breadcrumbs');
            currentUserIdDisplay = document.getElementById('current-user-id-display');
            
            adminUserList = document.getElementById('admin-user-list');
            generateCategoryDescBtn = document.getElementById('generate-category-description-btn');
            categoryNameInput = document.getElementById('category-name');
            categoryDescriptionInput = document.getElementById('category-description');
            suggestTopicTitleBtn = document.getElementById('suggest-topic-title-btn');
            newTopicContentInput = document.getElementById('new-topic-content');
            newTopicTitleInput = document.getElementById('new-topic-title');
            newTopicCommandInput = document.getElementById('new-topic-command');

            myProfileNicknameInput = document.getElementById('my-profile-nickname');
            myProfileSteamUrlInput = document.getElementById('my-profile-steam-url');
            myProfileEmailDisplay = document.getElementById('my-profile-email');
            myProfileRoleDisplay = document.getElementById('my-profile-role');
            myProfileSaveBtn = document.getElementById('my-profile-save-btn');

            userProfileViewDisplayName = document.getElementById('user-profile-view-displayName');
            userProfileViewNickname = document.getElementById('user-profile-view-nickname');
            userProfileViewEmail = document.getElementById('user-profile-view-email');
            userProfileViewRole = document.getElementById('user-profile-view-role');
            userProfileViewSteamLink = document.getElementById('user-profile-view-steam-link');
            userProfileViewRegisteredDate = document.getElementById('user-profile-view-registered-date');
            
            adminRoleColorSettings = document.getElementById('admin-role-color-settings');
            saveRoleColorsBtn = document.getElementById('save-role-colors-btn');
            
            adminForumNameInput = document.getElementById('admin-forum-name');
            saveForumNameBtn = document.getElementById('save-forum-name-btn');
            adminRegistrationsToggle = document.getElementById('admin-registrations-toggle');
            saveRegistrationSettingsBtn = document.getElementById('save-registration-settings-btn');

            csServersListAdmin = document.getElementById('cs-servers-list-admin');
            addCsServerBtn = document.getElementById('add-cs-server-btn');
            csServerModal = document.getElementById('cs-server-modal');
            csServerForm = document.getElementById('cs-server-form');
            csServerIdInput = document.getElementById('cs-server-id');
            csServerNameInput = document.getElementById('cs-server-name');
            csServerConnectInput = document.getElementById('cs-server-connect');
            cancelCsServerBtn = document.getElementById('cancel-cs-server');
            serverInfoBannerContainer = document.getElementById('server-info-banner-container');
            
            recentMembersList = document.getElementById('recent-members-list');
            editPostModal = document.getElementById('edit-post-modal');
            editPostContentInput = document.getElementById('edit-post-content');
            saveEditPostBtn = document.getElementById('save-edit-post-btn');
            cancelEditPostBtn = document.getElementById('cancel-edit-post-btn');

            chatMessagesContainer = document.getElementById('chat-messages');
            chatMessageInput = document.getElementById('chat-message-input');
            sendChatMessageBtn = document.getElementById('send-chat-message-btn');
            backToForumFromProfileBtn = document.getElementById('back-to-forum-from-profile'); 

            adminPermissionsSettings = document.getElementById('admin-permissions-settings');
            savePermissionsBtn = document.getElementById('save-permissions-btn');
            categoryRolePermissionsAdminContainer = document.getElementById('category-role-permissions-admin-container');
            topicRolePermissionsContainer = document.getElementById('topic-role-permissions-container'); // For create topic modal
            
            editTopicModal = document.getElementById('edit-topic-modal');
            editTopicTitleInput = document.getElementById('edit-topic-title');
            editTopicRolePermissionsContainer = document.getElementById('edit-topic-role-permissions-container');
            saveEditTopicBtn = document.getElementById('save-edit-topic-btn');
            cancelEditTopicBtn = document.getElementById('cancel-edit-topic-btn');
        }

        document.addEventListener('DOMContentLoaded', () => {
            populateDomElementVariables(); 

            const showRegisterViewLink = document.getElementById('show-register-view');
            const showLoginViewLink = document.getElementById('show-login-view');

            if(showRegisterViewLink) {
                showRegisterViewLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (registrationsOpen) {
                        showView('register');
                    } else {
                        showModal("Novos cadastros estão temporariamente desabilitados.", "info");
                    }
                });
            }
            if(showLoginViewLink) {
                showLoginViewLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    showView('login');
                });
            }
            if (myProfileNav) {
                myProfileNav.addEventListener('click', (e) => {
                    e.preventDefault();
                    showView('myProfile');
                });
            }

            if (adminPanelNav && adminControls) {
                adminPanelNav.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (adminControls.style.display === 'none' || adminControls.style.display === '') {
                        adminControls.style.display = 'block';
                        adminPanelNav.textContent = 'Fechar Painel Admin';
                        if (hasPermission(PERMISSIONS.MANAGE_FORUM_SETTINGS)) {
                            loadUsersForAdmin(); 
                            loadAdminServerSettings(); 
                            loadRoleColorSettings();
                            loadRolePermissionsSettings();
                            populateCategoryRolePermissionsCheckboxes(); 
                            populateTopicRolePermissionsCheckboxes(topicRolePermissionsContainer); // For create topic modal
                        }
                    } else {
                        adminControls.style.display = 'none';
                        adminPanelNav.textContent = 'Painel Admin';
                    }
                });
            }


            if (myProfileSaveBtn) myProfileSaveBtn.addEventListener('click', saveMyProfile);
            if (saveRoleColorsBtn) saveRoleColorsBtn.addEventListener('click', saveRoleColors);
            if (saveForumNameBtn) saveForumNameBtn.addEventListener('click', saveForumName);
            if (saveRegistrationSettingsBtn) saveRegistrationSettingsBtn.addEventListener('click', saveRegistrationSettings);
            if (addCsServerBtn) addCsServerBtn.addEventListener('click', () => openCsServerModal());
            if (csServerForm) csServerForm.addEventListener('submit', saveCsServer);
            if (cancelCsServerBtn) cancelCsServerBtn.addEventListener('click', () => csServerModal.style.display = 'none');
            if (saveEditPostBtn) saveEditPostBtn.addEventListener('click', saveEditedPost);
            if (cancelEditPostBtn) cancelEditPostBtn.addEventListener('click', () => editPostModal.style.display = 'none');
            if (sendChatMessageBtn) sendChatMessageBtn.addEventListener('click', sendChatMessage);
            if (chatMessageInput) {
                chatMessageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendChatMessage();
                    }
                });
            }
            if (backToForumFromProfileBtn) backToForumFromProfileBtn.addEventListener('click', () => showView('forumHome'));
            if (savePermissionsBtn) savePermissionsBtn.addEventListener('click', saveRolePermissions);
            
            const loginForm = document.getElementById('login-form');
            if (loginForm) loginForm.addEventListener('submit', handleLogin);
            
            const registerForm = document.getElementById('register-form');
            if (registerForm) registerForm.addEventListener('submit', handleRegister);

            if (logoutNav) logoutNav.addEventListener('click', handleLogout);
            if (loginNav) loginNav.addEventListener('click', (e) => { e.preventDefault(); showView('login'); });
            if (registerNav) registerNav.addEventListener('click', (e) => {
                e.preventDefault();
                if (registrationsOpen) {
                    showView('register');
                } else {
                    showModal("Novos cadastros estão temporariamente desabilitados.", "info");
                }
            });

            const createCategoryForm = document.getElementById('create-category-form');
            if (createCategoryForm) createCategoryForm.addEventListener('submit', handleCreateCategory);

            const createTopicFormModal = document.getElementById('create-topic-form-modal');
            if (createTopicFormModal) createTopicFormModal.addEventListener('submit', handleCreateTopic);
            
            const showCreateTopicModalBtn = document.getElementById('show-create-topic-modal');
            if(showCreateTopicModalBtn) showCreateTopicModalBtn.addEventListener('click', openCreateTopicModal);

            const cancelCreateTopicBtn = document.getElementById('cancel-create-topic');
            if(cancelCreateTopicBtn) cancelCreateTopicBtn.addEventListener('click', () => {
                document.getElementById('create-topic-modal').style.display = 'none';
            });

            const createPostForm = document.getElementById('create-post-form');
            if (createPostForm) createPostForm.addEventListener('submit', handleCreatePost);
            
            if (breadcrumbs) breadcrumbs.addEventListener('click', handleBreadcrumbNavigation);
            if (categoriesList) categoriesList.addEventListener('click', handleCategoryListClick);
            if (topicsList) topicsList.addEventListener('click', handleTopicListClick);
            if (postsList) postsList.addEventListener('click', handlePostListClick);

            if (generateCategoryDescBtn) generateCategoryDescBtn.addEventListener('click', generateCategoryDescription);
            if (suggestTopicTitleBtn) suggestTopicTitleBtn.addEventListener('click', suggestTopicTitle);

            if (saveEditTopicBtn) saveEditTopicBtn.addEventListener('click', saveEditedTopic);
            if (cancelEditTopicBtn) cancelEditTopicBtn.addEventListener('click', () => editTopicModal.style.display = 'none');


            if (auth) {
                initAuth(); 
            } else {
                console.warn("Firebase Auth not available at DOMContentLoaded. Login might be impaired.");
                showView('login'); 
            }
        });

        function updateBreadcrumbs(path) {
            if (!breadcrumbs) return;
            breadcrumbs.innerHTML = `<a href="#" data-view="forumHome" class="hover:text-blue-400">Início</a>`;
            path.forEach(p => {
                breadcrumbs.innerHTML += ` <span class="text-gray-500">/</span> <a href="#" data-view="${p.view}" data-id="${p.id || ''}" class="hover:text-blue-400">${p.name}</a>`;
            });
        }

        function handleBreadcrumbNavigation(e) {
            if (e.target.tagName === 'A' && e.target.dataset.view) {
                e.preventDefault();
                const view = e.target.dataset.view;
                const id = e.target.dataset.id;
                if (view === 'forumHome') loadCategories();
                else if (view === 'category' && id) loadTopics(id, e.target.textContent);
            }
        }

        function clearFirestoreListeners() {
            if (unsubscribeCategories) unsubscribeCategories();
            if (unsubscribeTopics) unsubscribeTopics();
            if (unsubscribePosts) unsubscribePosts();
            if (unsubscribeServerConfig) unsubscribeServerConfig();
            if (unsubscribeRecentMembers) unsubscribeRecentMembers();
            if (unsubscribeChatMessages) unsubscribeChatMessages();
            if (unsubscribeCurrentUserProfile) unsubscribeCurrentUserProfile(); 
            unsubscribeCategories = null;
            unsubscribeTopics = null;
            unsubscribePosts = null;
            unsubscribeServerConfig = null;
            unsubscribeRecentMembers = null;
            unsubscribeChatMessages = null;
            unsubscribeCurrentUserProfile = null;
            console.log("All Firestore listeners cleared.");
        }

        if (auth) {
            onAuthStateChanged(auth, async (user) => {
                clearFirestoreListeners();
                showView('loading');
                if (user) {
                    currentUser = user;
                    currentUserId = user.uid;
                    const userProfileRef = doc(db, `artifacts/${firestorePathAppId}/public/data/userProfiles`, currentUserId);

                    unsubscribeCurrentUserProfile = onSnapshot(userProfileRef, async (profileSnap) => {
                        if (!currentUser) return; 

                        let initialProfileLoad = !userProfileData; 

                        if (profileSnap.exists()) {
                            const updatedProfileData = profileSnap.data();
                            const oldRole = userProfileData ? userProfileData.role : null;
                            userProfileData = updatedProfileData;
                            isAdmin = (userProfileData.role === 'Admin');
                            
                            console.log("[Profile Listener] Profile data updated:", userProfileData);

                            if (userProfileData.role && serverRolePermissionsConfig[userProfileData.role]) {
                                currentRolePermissions = serverRolePermissionsConfig[userProfileData.role];
                            } else { 
                                currentRolePermissions = {};
                                if (userProfileData.role) console.warn(`Role "${userProfileData.role}" not found in serverRolePermissionsConfig.`);
                            }
                            console.log("[Profile Listener] Current role permissions set:", currentRolePermissions);


                            userDisplay.textContent = `Bem-vindo, ${userProfileData.nickname || userProfileData.displayName || currentUser.email.split('@')[0]}`;
                            currentUserIdDisplay.style.display = isAdmin ? 'inline-block' : 'none';
                            currentUserIdDisplay.textContent = isAdmin ? `User ID: ${currentUserId}` : '';
                            
                            if (views.myProfile && views.myProfile.classList.contains('active-view')) {
                                loadMyProfileView(); 
                            }
                            if (initialProfileLoad || (oldRole && oldRole !== userProfileData.role)) {
                                console.log(`[Profile Listener] Initial profile load (${initialProfileLoad}) or role change (from ${oldRole} to ${userProfileData.role}). Refreshing UI components.`);
                                adminPanelNav.style.display = hasPermission(PERMISSIONS.MANAGE_FORUM_SETTINGS) ? 'inline-block' : 'none';
                                if (hasPermission(PERMISSIONS.MANAGE_FORUM_SETTINGS) && adminControls.style.display === 'block') {
                                    loadUsersForAdmin(); 
                                    loadAdminServerSettings(); 
                                    loadRoleColorSettings();
                                    loadRolePermissionsSettings();
                                    populateCategoryRolePermissionsCheckboxes(); 
                                    populateTopicRolePermissionsCheckboxes(topicRolePermissionsContainer);
                                } else if (!hasPermission(PERMISSIONS.MANAGE_FORUM_SETTINGS)) {
                                    adminControls.style.display = 'none'; 
                                    adminPanelNav.textContent = 'Painel Admin';
                                }
                            }


                        } else {
                            console.log("[Profile Listener] User profile does not exist. Attempting to create.");
                            try {
                                userProfileData = {
                                    email: currentUser.email,
                                    displayName: currentUser.email ? currentUser.email.split('@')[0] : 'Usuário ' + currentUser.uid.substring(0,5),
                                    nickname: "",
                                    steamProfileUrl: "",
                                    createdAt: Timestamp.now(),
                                    lastSeen: Timestamp.now(),
                                    role: 'Membro' 
                                };
                                await setDoc(userProfileRef, userProfileData);
                                console.log("[Auth/Profile Listener] New user profile created:", JSON.stringify(userProfileData));
                                isAdmin = (userProfileData.role === 'Admin'); 
                                initialProfileLoad = true; 
                            } catch (error) {
                                console.error("[Auth/Profile Listener] Error creating user profile:", error);
                                showModal("Erro ao criar perfil de usuário: " + error.message);
                                userProfileData = { role: 'Membro', lastSeen: Timestamp.now() }; 
                                isAdmin = false;
                            }
                        }

                        if (initialProfileLoad && userProfileData) { 
                            loginNav.style.display = 'none';
                            logoutNav.style.display = 'inline-block';
                            myProfileNav.style.display = 'inline-block';
                            adminPanelNav.style.display = hasPermission(PERMISSIONS.MANAGE_FORUM_SETTINGS) ? 'inline-block' : 'none';
                            
                            try {
                                await loadServerConfig(); 
                                console.log("[Auth State] Server config loaded. Proceeding with other data loads.");
                                if (hasPermission(PERMISSIONS.MANAGE_FORUM_SETTINGS) && adminControls.style.display === 'block') {
                                    loadUsersForAdmin();
                                    loadAdminServerSettings(); 
                                    loadRoleColorSettings();
                                    loadRolePermissionsSettings();
                                    populateCategoryRolePermissionsCheckboxes();
                                    populateTopicRolePermissionsCheckboxes(topicRolePermissionsContainer);
                                } else if (!hasPermission(PERMISSIONS.MANAGE_FORUM_SETTINGS)) {
                                     adminControls.style.display = 'none';
                                }
                                registerNav.style.display = registrationsOpen ? 'inline-block' : 'none';
                                loadCategories();
                                loadRecentMembers();
                                loadChatMessages();
                                showView('forumHome'); 
                            } catch (error) {
                                console.error("Failed to load initial server config:", error);
                                showModal("Erro crítico ao carregar configurações do servidor.", "error");
                                registerNav.style.display = 'inline-block'; 
                                showView('forumHome'); 
                            }
                        }
                    }, (error) => {
                        console.error("[Profile Listener] Error listening to user profile:", error);
                        showModal("Erro ao carregar dados do perfil. Tente recarregar.", "error");
                        if (auth) signOut(auth);
                    });
                    
                    try {
                        await updateDoc(userProfileRef, { lastSeen: Timestamp.now() });
                    } catch (e) { console.warn("Could not update lastSeen initially:", e.message); }

                } else { 
                    if (unsubscribeCurrentUserProfile) { 
                        unsubscribeCurrentUserProfile();
                        unsubscribeCurrentUserProfile = null;
                    }
                    currentUser = null;
                    currentUserId = null; 
                    userProfileData = null;
                    isAdmin = false;
                    currentRolePermissions = {};

                    userDisplay.textContent = 'Você não está logado.';
                    currentUserIdDisplay.style.display = 'none';
                    loginNav.style.display = 'inline-block';
                    logoutNav.style.display = 'none';
                    myProfileNav.style.display = 'none';
                    adminControls.style.display = 'none';
                    adminPanelNav.style.display = 'none';
                    adminPanelNav.textContent = 'Painel Admin';
                    
                    await loadServerConfig(); 
                    registerNav.style.display = registrationsOpen ? 'inline-block' : 'none';

                    if(serverInfoBannerContainer) serverInfoBannerContainer.innerHTML = ''; 
                    if(recentMembersList) recentMembersList.innerHTML = ''; 
                    if(chatMessagesContainer) chatMessagesContainer.innerHTML = ''; 
                    showView('login');
                }
            });
        } else {
            console.error("Auth service is not available.");
            showModal("Serviço de autenticação indisponível.");
            showView('login');
        }

        async function initAuth() {
            if (!auth) {
                console.error("Firebase Auth not initialized. Skipping initAuth.");
                showView('login'); 
                return;
            }
            showView('loading');
            try {
                if (finalInitialAuthToken) { 
                    console.log("Attempting sign-in with determined custom token.");
                    await signInWithCustomToken(auth, finalInitialAuthToken);
                    console.log("Successfully signed in with custom token.");
                } else {
                     console.log("No custom token. Waiting for onAuthStateChanged or user login.");
                     if (!auth.currentUser) { 
                        showView('login'); 
                     }
                }
            } catch (error) {
                console.error("Authentication initialization error:", error); 
                showModal("Erro na autenticação automática: " + error.message + ". Por favor, faça login manualmente.", "error");
                showView('login');
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            if (!auth) { showModal("Serviço de autenticação indisponível."); return; }
            const email = e.target.email.value;
            const password = e.target.password.value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("Error signing in:", error);
                showModal("Erro ao fazer login: " + error.message);
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            if (!registrationsOpen) {
                showModal("Novos cadastros estão temporariamente desabilitados.", "error");
                return;
            }
            if (!auth) { showModal("Serviço de autenticação indisponível."); return; }
            const email = e.target.email.value;
            const password = e.target.password.value;
            const confirmPassword = e.target.confirmPassword.value;

            if (password !== confirmPassword) {
                showModal("As senhas não coincidem.");
                return;
            }
            
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                showModal("Registro bem-sucedido! Faça o login.", "success");
                showView('login'); 
            } catch (error) {
                console.error("Error registering:", error);
                showModal("Erro ao registrar: " + error.message);
            }
        }

        async function handleLogout() {
            if (!auth) { showModal("Serviço de autenticação indisponível."); return; }
            try {
                if(currentUser && db && currentUserId) { 
                    const userProfileRef = doc(db, `artifacts/${firestorePathAppId}/public/data/userProfiles`, currentUserId);
                    await updateDoc(userProfileRef, { lastSeen: Timestamp.now() });
                }
                await signOut(auth);
            } catch (error) {
                console.error("Error signing out:", error);
                showModal("Erro ao fazer logout: " + error.message);
            }
        }
        
        let categoriesCol, topicsCol, postsCol, userProfilesCol, serverConfigDocRef, chatMessagesCol;
        if (db) {
            categoriesCol = collection(db, `artifacts/${firestorePathAppId}/public/data/categories`);
            topicsCol = collection(db, `artifacts/${firestorePathAppId}/public/data/topics`);
            postsCol = collection(db, `artifacts/${firestorePathAppId}/public/data/posts`);
            userProfilesCol = collection(db, `artifacts/${firestorePathAppId}/public/data/userProfiles`);
            serverConfigDocRef = doc(db, `artifacts/${firestorePathAppId}/public/data/serverConfig`, 'config');
            chatMessagesCol = collection(db, `artifacts/${firestorePathAppId}/public/data/chatMessages`);
        } else {
            console.error("Firestore DB service is not available.");
        }
        
        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            textarea.setSelectionRange(0, 99999); 
            try {
                document.execCommand('copy');
                showModal('Comando copiado para a área de transferência!', 'success');
            } catch (err) {
                showModal('Falha ao copiar. Seu navegador pode não suportar esta ação.', 'error');
                console.error('Fallback: Oops, unable to copy', err);
            }
            document.body.removeChild(textarea);
        }

        async function loadAdminServerSettings() { 
            if (!db || !serverConfigDocRef || !adminForumNameInput || !adminRegistrationsToggle) return;
            try {
                const docSnap = await getDoc(serverConfigDocRef); 
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    adminForumNameInput.value = data.forumName || 'Negativa Server - Fórum';
                    adminRegistrationsToggle.checked = data.registrationsOpen === undefined ? true : data.registrationsOpen;
                    renderAdminCsServersList(data.csServers || []);
                } else { 
                    adminForumNameInput.value = 'Negativa Server - Fórum'; 
                    adminRegistrationsToggle.checked = true; 
                    renderAdminCsServersList([]);
                }
            } catch (error) {
                console.error("Error loading server settings for admin:", error);
            }
        }
        
        async function saveForumName() {
            if (!hasPermission(PERMISSIONS.MANAGE_FORUM_SETTINGS)) {
                 showModal("Você não tem permissão para alterar o nome do fórum.", "error"); return;
            }
            const newName = adminForumNameInput.value.trim();
            if (!newName) {
                showModal("O nome do fórum não pode estar vazio.", "error"); return;
            }
            try {
                await setDoc(serverConfigDocRef, { forumName: newName }, { merge: true });
                showModal("Nome do fórum salvo com sucesso!", "success");
            } catch (error) {
                console.error("Error saving forum name:", error);
                showModal("Erro ao salvar nome do fórum: " + error.message, "error");
            }
        }
        
        async function saveRegistrationSettings() {
            if (!hasPermission(PERMISSIONS.MANAGE_FORUM_SETTINGS)) {
                showModal("Você não tem permissão para alterar as configurações de registro.", "error"); return;
            }
            const newRegistrationsOpen = adminRegistrationsToggle.checked;
            try {
                await setDoc(serverConfigDocRef, { registrationsOpen: newRegistrationsOpen }, { merge: true });
                showModal(`Cadastros ${newRegistrationsOpen ? 'abertos' : 'fechados'} com sucesso!`, "success");
            } catch (error) {
                console.error("Error saving registration settings:", error);
                showModal("Erro ao salvar configurações de registro: " + error.message, "error");
            }
        }

        
        function renderAdminCsServersList(servers = []) {
            if (!csServersListAdmin) return;
            csServersListAdmin.innerHTML = '';
            if (servers.length === 0) {
                csServersListAdmin.innerHTML = '<p class="text-sm text-gray-400">Nenhum servidor CS2 configurado.</p>';
                return;
            }
            servers.forEach((server, index) => {
                const serverDiv = document.createElement('div');
                serverDiv.className = 'bg-gray-700 p-2 rounded-md mb-2 flex justify-between items-center';
                serverDiv.innerHTML = `
                    <div>
                        <p class="text-sm font-medium">${server.displayName || 'Servidor sem nome'}</p>
                        <p class="text-xs text-gray-400">${server.connectCommand || 'Comando não definido'}</p>
                    </div>
                    <div>
                        <button class="edit-cs-server-btn text-yellow-400 hover:text-yellow-300 text-xs mr-2" data-index="${index}">Editar</button>
                        <button class="delete-cs-server-btn text-red-500 hover:text-red-400 text-xs" data-index="${index}">Excluir</button>
                    </div>
                `;
                csServersListAdmin.appendChild(serverDiv);
            });

            csServersListAdmin.querySelectorAll('.edit-cs-server-btn').forEach(btn => {
                btn.addEventListener('click', (e) => openCsServerModal(parseInt(e.target.dataset.index)));
            });
            csServersListAdmin.querySelectorAll('.delete-cs-server-btn').forEach(btn => {
                btn.addEventListener('click', (e) => deleteCsServer(parseInt(e.target.dataset.index)));
            });
        }

        async function openCsServerModal(index = null) {
            if (!csServerForm || !csServerModal || !csServerIdInput || !csServerNameInput || !csServerConnectInput) return;
            csServerForm.reset();
            csServerIdInput.value = index !== null ? index : ''; 
            if (index !== null) {
                const docSnap = await getDoc(serverConfigDocRef); 
                if (docSnap.exists() && docSnap.data().csServers && docSnap.data().csServers[index]) {
                    const server = docSnap.data().csServers[index];
                    csServerNameInput.value = server.displayName || '';
                    csServerConnectInput.value = server.connectCommand || '';
                }
            }
            csServerModal.style.display = 'flex';
        }

        async function saveCsServer(e) {
            e.preventDefault();
            if (!hasPermission(PERMISSIONS.MANAGE_FORUM_SETTINGS)) {
                 showModal("Você não tem permissão para gerenciar servidores.", "error"); return;
            }
            const serverId = csServerIdInput.value; 
            const displayName = csServerNameInput.value.trim();
            const connectCommand = csServerConnectInput.value.trim();

            if (!displayName || !connectCommand) {
                showModal("Nome de exibição e comando de conexão são obrigatórios.", "error"); return;
            }

            try {
                const docSnap = await getDoc(serverConfigDocRef);
                let currentServers = [];
                if (docSnap.exists() && docSnap.data().csServers) {
                    currentServers = [...docSnap.data().csServers]; 
                }

                const newServer = { displayName, connectCommand };
                if (serverId !== '' && currentServers[parseInt(serverId)]) { 
                    currentServers[parseInt(serverId)] = newServer;
                } else { 
                    currentServers.push(newServer);
                }
                
                await setDoc(serverConfigDocRef, { csServers: currentServers }, { merge: true });
                showModal(`Servidor CS2 ${serverId !== '' ? 'atualizado' : 'adicionado'} com sucesso!`, "success");
                if(csServerModal) csServerModal.style.display = 'none';
            } catch (error) {
                console.error("Error saving CS server:", error);
                showModal("Erro ao salvar servidor CS2: " + error.message, "error");
            }
        }
        
        async function deleteCsServer(index) {
             if (!hasPermission(PERMISSIONS.MANAGE_FORUM_SETTINGS)) {
                 showModal("Você não tem permissão para gerenciar servidores.", "error"); return;
            }
            confirmAction("Tem certeza que deseja excluir este servidor CS2?", async () => {
                try {
                    const docSnap = await getDoc(serverConfigDocRef);
                    if (docSnap.exists() && docSnap.data().csServers) {
                        let currentServers = [...docSnap.data().csServers];
                        currentServers.splice(index, 1); 
                        await setDoc(serverConfigDocRef, { csServers: currentServers }, { merge: true });
                        showModal("Servidor CS2 excluído com sucesso!", "success");
                    }
                } catch (error) {
                    console.error("Error deleting CS server:", error);
                    showModal("Erro ao excluir servidor CS2: " + error.message, "error");
                }
            });
        }

        function loadPublicCsServerBanners(serversFromConfig) { 
            if (!serverInfoBannerContainer) return;
            serverInfoBannerContainer.innerHTML = ''; 
            if (serversFromConfig && serversFromConfig.length > 0) {
                serversFromConfig.forEach(server => {
                    if (server.displayName && server.connectCommand) {
                        const banner = document.createElement('div');
                        banner.className = 'container mx-auto mt-2 bg-gray-700 p-3 text-center rounded-md shadow';
                        banner.innerHTML = `
                            <p class="text-base sm:text-lg text-gray-100">
                                ${server.displayName}: 
                                <a href="steam://connect/${server.connectCommand.replace('connect ', '')}" target="_blank" class="text-yellow-400 hover:text-yellow-300 font-semibold underline">${server.connectCommand.replace('connect ', '')}</a>
                                <button class="copy-cs-command-btn ml-3 bg-blue-500 hover:bg-blue-600 text-white text-xs py-1 px-3 rounded-md transition duration-150" data-command="${server.connectCommand}">Copiar Comando</button>
                            </p>
                        `;
                        serverInfoBannerContainer.appendChild(banner);
                    }
                });
                serverInfoBannerContainer.querySelectorAll('.copy-cs-command-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => copyToClipboard(e.target.dataset.command));
                });
            }
        }


        async function loadUsersForAdmin() {
            if (!db || !userProfilesCol || !hasPermission(PERMISSIONS.MANAGE_USERS) || !adminUserList) return;
            adminUserList.innerHTML = '<div class="loading-spinner"></div><p class="text-gray-400 text-center">Carregando usuários...</p>';
            try {
                const snapshot = await getDocs(query(userProfilesCol)); 
                if (snapshot.empty) {
                    adminUserList.innerHTML = '<p class="text-gray-400 p-4 text-center">Nenhum usuário registrado encontrado.</p>';
                    return;
                }
                let usersHtml = '';
                const userDocs = snapshot.docs.sort((a,b) => (a.data().email || '').localeCompare(b.data().email || ''));

                userDocs.forEach(userDoc => {
                    const userId = userDoc.id;
                    const profile = userDoc.data();
                    const isCurrentUserAdminEditingSelf = profile.role === 'Admin' && currentUserId === userId;

                    usersHtml += `
                        <div class="bg-gray-700 p-3 rounded-md flex flex-col sm:flex-row justify-between items-start sm:items-center">
                            <div class="mb-2 sm:mb-0">
                                <p class="text-sm font-medium">${profile.nickname || profile.displayName || profile.email || 'N/A'}</p>
                                <p class="text-xs text-gray-400">Email: ${profile.email || 'N/A'} | Cargo: <span id="role-display-${userId}">${profile.role || 'Membro'}</span></p>
                                <p class="text-xs text-gray-500">Registrado em: ${formatTimestamp(profile.createdAt)} | Visto por último: ${formatTimestamp(profile.lastSeen)}</p>
                                <input type="text" id="nickname-edit-${userId}" value="${profile.nickname || ''}" placeholder="Nickname" class="mt-1 p-1 text-xs bg-gray-600 border border-gray-500 rounded-md text-gray-100 w-full sm:w-auto">
                                <input type="url" id="steamurl-edit-${userId}" value="${profile.steamProfileUrl || ''}" placeholder="URL Perfil Steam" class="mt-1 p-1 text-xs bg-gray-600 border border-gray-500 rounded-md text-gray-100 w-full sm:w-auto">
                            </div>
                            <div class="flex items-center mt-2 sm:mt-0">
                                <select id="select-role-${userId}" class="bg-gray-600 border border-gray-500 text-gray-100 text-xs rounded-md p-1 mr-2 w-full sm:w-auto" ${isCurrentUserAdminEditingSelf ? 'disabled' : ''}>
                                    ${defaultRoles.map(role => `<option value="${role}" ${profile.role === role ? 'selected' : ''}>${role}</option>`).join('')}
                                </select>
                                <button data-userid="${userId}" class="save-user-details-btn bg-blue-500 hover:bg-blue-600 text-white text-xs py-1 px-2 rounded" ${isCurrentUserAdminEditingSelf ? 'disabled' : ''}>Salvar</button>
                            </div>
                        </div>
                    `;
                });
                adminUserList.innerHTML = usersHtml;

                document.querySelectorAll('.save-user-details-btn').forEach(button => {
                    if (button.disabled) return; 
                    button.addEventListener('click', async (e) => {
                        const userIdToUpdate = e.target.dataset.userid;
                        const newRole = document.getElementById(`select-role-${userIdToUpdate}`).value;
                        const newNickname = document.getElementById(`nickname-edit-${userIdToUpdate}`).value.trim();
                        const newSteamUrl = document.getElementById(`steamurl-edit-${userIdToUpdate}`).value.trim();
                        await updateUserDetailsByAdmin(userIdToUpdate, newRole, newNickname, newSteamUrl);
                    });
                });

            } catch (error) {
                console.error("Error loading users for admin:", error);
                adminUserList.innerHTML = '<p class="text-red-400 p-4 text-center">Erro ao carregar usuários.</p>';
                showModal("Erro ao carregar usuários: " + error.message, "error");
            }
        }
        
        async function updateUserDetailsByAdmin(userId, newRole, newNickname, newSteamUrl) {
            if (!hasPermission(PERMISSIONS.MANAGE_USERS)) {
                 showModal("Você não tem permissão para gerenciar usuários.", "error"); return;
            }
            const userToUpdateRef = doc(userProfilesCol, userId);
            try {
                if (userId === currentUserId && newRole !== 'Admin' && isAdmin) { 
                     showModal("Administradores não podem remover seu próprio cargo de 'Admin'.", "error");
                     document.getElementById(`select-role-${userId}`).value = 'Admin'; 
                     return;
                }
                await updateDoc(userToUpdateRef, { 
                    role: newRole,
                    nickname: newNickname,
                    steamProfileUrl: newSteamUrl
                });
                showModal(`Detalhes do usuário atualizados.`, "success");
                const roleDisplaySpan = document.getElementById(`role-display-${userId}`);
                if (roleDisplaySpan) roleDisplaySpan.textContent = newRole; 
            } catch (error) {
                console.error("Error updating user details by admin:", error);
                showModal("Erro ao atualizar detalhes do usuário: " + error.message, "error");
            }
        }

        function populateCategoryRolePermissionsCheckboxes() {
            if (!categoryRolePermissionsAdminContainer) return;
            categoryRolePermissionsAdminContainer.innerHTML = ''; 
            defaultRoles.forEach(role => {
                if (role === 'Admin') return; 
                const checkboxId = `category-perm-role-${role}`;
                const label = document.createElement('label');
                label.className = 'flex items-center space-x-2 text-sm text-gray-300';
                label.innerHTML = `
                    <input type="checkbox" id="${checkboxId}" name="categoryAllowedRoles" value="${role}" 
                           class="form-checkbox h-4 w-4 text-blue-500 bg-gray-600 border-gray-500 rounded focus:ring-blue-400">
                    <span>${role}</span>
                `;
                categoryRolePermissionsAdminContainer.appendChild(label);
            });
        }

        function populateTopicRolePermissionsCheckboxes(container, currentAllowedRoles = []) {
            if (!container) return;
            container.innerHTML = ''; // Clear existing
            defaultRoles.forEach(role => {
                if (role === 'Admin') return; // Admins always have access
                const checkboxId = `topic-perm-role-${role}-${container.id}`; // Make ID unique per container
                const isChecked = currentAllowedRoles.includes(role);
                const label = document.createElement('label');
                label.className = 'flex items-center space-x-2 text-sm text-gray-300';
                label.innerHTML = `
                    <input type="checkbox" id="${checkboxId}" name="topicAllowedRoles" value="${role}" 
                           class="form-checkbox h-4 w-4 text-blue-500 bg-gray-600 border-gray-500 rounded focus:ring-blue-400"
                           ${isChecked ? 'checked' : ''}>
                    <span>${role}</span>
                `;
                container.appendChild(label);
            });
        }


        async function handleCreateCategory(e) {
            e.preventDefault();
             if (!hasPermission(PERMISSIONS.MANAGE_CATEGORIES)) {
                 showModal("Você não tem permissão para criar categorias.", "error"); return;
            }
            const name = categoryNameInput.value.trim(); 
            const description = categoryDescriptionInput.value.trim(); 
            if (!name) {
                showModal("O nome da categoria é obrigatório.", "error"); return;
            }

            const selectedRoles = [];
            const checkboxes = document.querySelectorAll('#category-role-permissions-admin-container input[name="categoryAllowedRoles"]:checked');
            checkboxes.forEach(checkbox => selectedRoles.push(checkbox.value));

            try {
                const userDisplayNameForActivity = userProfileData?.nickname || userProfileData?.displayName || (currentUser?.email?.split('@')[0] || "Sistema");
                await addDoc(categoriesCol, {
                    name,
                    description,
                    createdBy: currentUserId,
                    createdAt: Timestamp.now(),
                    topicCount: 0,
                    postCount: 0,
                    lastActivity: Timestamp.now(), 
                    lastActivityDetails: { 
                        topicId: null,
                        topicTitle: "Nenhum tópico ainda",
                        userId: currentUserId, 
                        userDisplayName: userDisplayNameForActivity,
                        timestamp: Timestamp.now()
                    },
                    allowedRoles: selectedRoles 
                });
                showModal("Categoria criada com sucesso!", "success");
                e.target.reset();
                document.querySelectorAll('#category-role-permissions-admin-container input[name="categoryAllowedRoles"]').forEach(cb => cb.checked = false);

            } catch (error) {
                console.error("Error creating category:", error);
                showModal("Erro ao criar categoria: " + error.message);
            }
        }

        async function loadCategories() {
            if (!db || !categoriesCol || !userProfilesCol || !categoriesList) { 
                if(categoriesList) categoriesList.innerHTML = '<div class="p-4 text-center text-red-400">Erro: Serviço de banco de dados indisponível.</div>';
                showView('forumHome'); 
                return; 
            }
            if (!currentUser) { 
                console.log("loadCategories called without current user, redirecting to login.");
                showView('login'); return;
            }
            showView('loading');
            updateBreadcrumbs([]);
            
            categoriesList.innerHTML = '<div class="loading-spinner"></div><p class="text-gray-400 text-center">Carregando categorias...</p>';
            const q = query(categoriesCol); 
            
            if (unsubscribeCategories) unsubscribeCategories(); 
            unsubscribeCategories = onSnapshot(q, async (snapshot) => {
                if (!currentUser) return; 
                
                const categoriesToShow = [];
                if (snapshot.empty) {
                    categoriesList.innerHTML = '<div class="p-6 text-center text-gray-400 bg-gray-800 rounded-lg shadow">Nenhuma categoria encontrada. Que tal o administrador criar a primeira?</div>';
                    showView('forumHome');
                    return;
                }

                snapshot.docs.forEach(doc => {
                    const category = doc.data();
                    category.id = doc.id; 
                    if (isAdmin) {
                        categoriesToShow.push(category);
                    } else {
                        const allowed = category.allowedRoles;
                        if (!allowed || allowed.length === 0 || (userProfileData && allowed.includes(userProfileData.role))) {
                            categoriesToShow.push(category);
                        }
                    }
                });

                if (categoriesToShow.length === 0 && !isAdmin) { 
                     categoriesList.innerHTML = '<div class="p-6 text-center text-gray-400 bg-gray-800 rounded-lg shadow">Nenhuma categoria disponível para seu cargo.</div>';
                     showView('forumHome');
                     return;
                }


                const userIdsForLastActivity = new Set();
                categoriesToShow.forEach(cat => {
                    const activityUserId = cat.lastActivityDetails?.userId;
                    if (activityUserId) userIdsForLastActivity.add(activityUserId);
                    const createdById = cat.createdBy; 
                    if (createdById) userIdsForLastActivity.add(createdById);
                });

                const activityUserProfiles = {};
                if (userIdsForLastActivity.size > 0) {
                    const profilePromises = Array.from(userIdsForLastActivity).map(uid => getDoc(doc(userProfilesCol, uid)));
                    try {
                        const profileSnaps = await Promise.all(profilePromises);
                        profileSnaps.forEach(snap => {
                            if (snap.exists()) {
                                const data = snap.data();
                                activityUserProfiles[snap.id] = data.nickname || data.displayName || data.email?.split('@')[0] || 'Desconhecido';
                            } else {
                                activityUserProfiles[snap.id] = 'Usuário Deletado';
                            }
                        });
                    } catch (err) {
                        console.error("Error fetching user profiles for category last activity:", err);
                    }
                }

                const sortedCategories = categoriesToShow.sort((a, b) => {
                    const timeA = a.lastActivityDetails?.timestamp?.seconds || a.createdAt?.seconds || 0;
                    const timeB = b.lastActivityDetails?.timestamp?.seconds || b.createdAt?.seconds || 0;
                    return timeB - timeA; 
                }); 

                let categoriesHtml = '';
                sortedCategories.forEach(category => {
                    const lastActivity = category.lastActivityDetails;
                    let lastActivityHtml = 'Nenhuma atividade recente.';
                    if (lastActivity && lastActivity.topicId && lastActivity.topicTitle !== "Nenhum tópico ainda") {
                        const userName = activityUserProfiles[lastActivity.userId] || 'Desconhecido';
                        lastActivityHtml = `
                            Último: <a href="#" class="text-blue-400 hover:underline" data-topic-id-link="${lastActivity.topicId}" data-topic-title-link="${lastActivity.topicTitle}" data-category-id-for-topic="${category.id}" data-category-name-for-topic="${category.name}">${lastActivity.topicTitle}</a><br>
                            por ${userName}, ${formatTimestamp(lastActivity.timestamp)}
                        `;
                    } else if (lastActivity && lastActivity.userDisplayName) { 
                         lastActivityHtml = `Criada por ${activityUserProfiles[lastActivity.userId] || lastActivity.userDisplayName}, ${formatTimestamp(lastActivity.timestamp)}`;
                    }


                    categoriesHtml += `
                        <div class="bg-gray-800 p-4 rounded-lg shadow hover:shadow-xl transition-shadow duration-200">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="text-xl font-semibold text-blue-400 hover:text-blue-300 cursor-pointer category-link" data-id="${category.id}" data-name="${category.name}">${category.name}</h3>
                                    <p class="text-gray-400 text-sm mt-1">${category.description || 'Sem descrição.'}</p>
                                    ${ (category.allowedRoles && category.allowedRoles.length > 0) ? `<p class="text-xs text-yellow-400 mt-1">Privado para: ${category.allowedRoles.join(', ')}</p>` : '<p class="text-xs text-green-400 mt-1">Público</p>'}
                                </div>
                                ${hasPermission(PERMISSIONS.MANAGE_CATEGORIES) ? `<button class="delete-category-btn text-red-500 hover:text-red-400 text-xs ml-2" data-id="${category.id}" data-name="${category.name}">Excluir</button>` : ''}
                            </div>
                            <div class="grid grid-cols-3 gap-2 text-xs text-gray-500 mt-3 pt-3 border-t border-gray-700">
                                <div>Tópicos: ${category.topicCount || 0}</div>
                                <div>Posts: ${category.postCount || 0}</div>
                                <div class="col-span-3 sm:col-span-1 text-left sm:text-right">${lastActivityHtml}</div>
                            </div>
                        </div>
                    `;
                });
                categoriesList.innerHTML = categoriesHtml;
                categoriesList.querySelectorAll('a[data-topic-id-link]').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation(); 
                        const topicId = e.target.dataset.topicIdLink;
                        const topicTitle = e.target.dataset.topicTitleLink;
                        currentCategoryId = e.target.dataset.categoryIdForTopic; 
                        currentCategoryName = e.target.dataset.categoryNameForTopic;
                        loadPosts(topicId, topicTitle);
                    });
                });

                showView('forumHome');
            }, (error) => {
                console.error("Error loading categories:", error);
                 if (currentUser && categoriesList) { 
                    categoriesList.innerHTML = '<div class="p-6 text-center text-red-400 bg-gray-800 rounded-lg shadow">Erro ao carregar categorias. Verifique as permissões do Firestore e a conexão.</div>';
                    showModal("Erro ao carregar categorias: " + error.message + ". Verifique as permissões do Firestore.");
                 }
                showView('forumHome');
            });
        }
        
        function handleCategoryListClick(e) {
            if (e.target.classList.contains('delete-category-btn')) {
                e.stopPropagation(); 
                const categoryId = e.target.dataset.id;
                const categoryName = e.target.dataset.name;
                confirmAction(`Tem certeza que deseja excluir a categoria "${categoryName}" e todos os seus tópicos e posts?`, async () => {
                    if (!db) { showModal("Serviço de banco de dados indisponível."); return; }
                    await deleteCategory(categoryId);
                });
            } else {
                const categoryLink = e.target.closest('.category-link');
                if (categoryLink && categoryLink.dataset.id) { 
                     loadTopics(categoryLink.dataset.id, categoryLink.dataset.name);
                }
            }
        }

        async function deleteCategory(categoryId) {
            if (!hasPermission(PERMISSIONS.MANAGE_CATEGORIES)) {
                 showModal("Você não tem permissão para deletar categorias.", "error"); return;
            }
            showModal("Excluindo categoria...", "info");
            try {
                const topicsInCatQuery = query(topicsCol, where("categoryId", "==", categoryId));
                const topicsInCatSnapshot = await getDocs(topicsInCatQuery);
                for (const topicDoc of topicsInCatSnapshot.docs) {
                    const postsInTopicQuery = query(postsCol, where("topicId", "==", topicDoc.id));
                    const postsInTopicSnapshot = await getDocs(postsInTopicQuery);
                    for (const postDoc of postsInTopicSnapshot.docs) {
                        await deleteDoc(doc(postsCol, postDoc.id));
                    }
                    await deleteDoc(doc(topicsCol, topicDoc.id));
                }
                await deleteDoc(doc(categoriesCol, categoryId));
                showModal("Categoria excluída com sucesso!", "success");
            } catch (error) {
                console.error("Error deleting category:", error);
                showModal("Erro ao excluir categoria: " + error.message, "error");
            }
        }

        let currentCategoryName = '';
        let currentCategoryId = null;
        let currentCategoryAllowedRoles = []; 

        function openCreateTopicModal() {
            if (!hasPermission(PERMISSIONS.CREATE_TOPIC)) {
                 showModal("Você não tem permissão para criar tópicos.", "error"); return;
            }
            if (!currentCategoryId) {
                showModal("Selecione uma categoria antes de criar um tópico.", "error"); return;
            }
            if (newTopicTitleInput) newTopicTitleInput.value = ''; 
            if (newTopicContentInput) newTopicContentInput.value = ''; 
            if (newTopicCommandInput) newTopicCommandInput.value = '';
            populateTopicRolePermissionsCheckboxes(topicRolePermissionsContainer, currentCategoryAllowedRoles); // Populate with category's roles as default
            
            const createTopicModal = document.getElementById('create-topic-modal');
            if(createTopicModal) createTopicModal.style.display = 'flex';
        }
        
        async function handleCreateTopic(e) {
            e.preventDefault();
            if (!hasPermission(PERMISSIONS.CREATE_TOPIC)) {
                 showModal("Você não tem permissão para criar tópicos.", "error"); return;
            }
            if (!currentUser || !currentCategoryId) {
                showModal("Você precisa estar logado e em uma categoria para criar um tópico.");
                return;
            }
            const title = newTopicTitleInput.value.trim(); 
            const content = newTopicContentInput.value.trim(); 
            const commandToCopy = newTopicCommandInput.value.trim();
            
            if (!title || !content) {
                showModal("Título e conteúdo do primeiro post são obrigatórios.");
                return;
            }

            const selectedTopicRoles = [];
            const topicRoleCheckboxes = document.querySelectorAll('#topic-role-permissions-container input[name="topicAllowedRoles"]:checked');
            topicRoleCheckboxes.forEach(checkbox => selectedTopicRoles.push(checkbox.value));


            const now = Timestamp.now();
            const userDisplayName = userProfileData?.nickname || userProfileData?.displayName || currentUser.email.split('@')[0];
            
            try {
                const topicRef = await addDoc(topicsCol, {
                    categoryId: currentCategoryId,
                    title,
                    createdBy: currentUserId,
                    userDisplayName: userDisplayName, 
                    createdAt: now,
                    replyCount: 0, 
                    postCount: 1, 
                    lastReplyAt: now,
                    lastReplyBy: currentUserId,
                    lastReplyByDisplayName: userDisplayName,
                    viewCount: 0,
                    allowedRoles: selectedTopicRoles.length > 0 ? selectedTopicRoles : [] // Store empty if none, to inherit from category or be public
                });

                await addDoc(postsCol, {
                    topicId: topicRef.id,
                    userId: currentUserId,
                    userDisplayName: userDisplayName,
                    content,
                    createdAt: now,
                    commandToCopy: commandToCopy || null 
                });
                
                const categoryRef = doc(categoriesCol, currentCategoryId);
                await updateDoc(categoryRef, {
                    topicCount: increment(1),
                    postCount: increment(1), 
                    lastActivity: now, 
                    lastActivityDetails: {
                        topicId: topicRef.id,
                        topicTitle: title,
                        userId: currentUserId,
                        userDisplayName: userDisplayName, 
                        timestamp: now
                    }
                });
                
                showModal("Tópico criado com sucesso!", "success");
                if (document.getElementById('create-topic-form-modal')) document.getElementById('create-topic-form-modal').reset(); 
                if (document.getElementById('create-topic-modal')) document.getElementById('create-topic-modal').style.display = 'none';
            } catch (error) {
                console.error("Error creating topic:", error);
                showModal("Erro ao criar tópico: " + error.message);
            }
        }


        async function loadTopics(categoryId, categoryName) {
            if (!db || !topicsCol || !userProfilesCol || !topicsList || !categoryTitle) { 
                if(topicsList) topicsList.innerHTML = '<div class="p-4 text-center text-red-400">Erro: Serviço de banco de dados indisponível.</div>';
                showView('category');
                return; 
            }
            if (!currentUser || !userProfileData) { // Ensure userProfileData is available for role checks
                 console.log("loadTopics: currentUser or userProfileData not available.");
                 showView('login'); return; 
            }

            showView('loading');
            currentCategoryId = categoryId;
            currentCategoryName = categoryName;
            categoryTitle.textContent = categoryName;
            updateBreadcrumbs([{name: categoryName, view: 'category', id: categoryId}]);

            const categoryRef = doc(categoriesCol, categoryId);
            const categorySnap = await getDoc(categoryRef);
            if (!categorySnap.exists()) {
                showModal("Categoria não encontrada.", "error");
                showView('forumHome');
                return;
            }
            const categoryData = categorySnap.data();
            currentCategoryAllowedRoles = categoryData.allowedRoles || []; 

            if (!isAdmin && currentCategoryAllowedRoles.length > 0 && !currentCategoryAllowedRoles.includes(userProfileData.role)) {
                topicsList.innerHTML = '<div class="p-6 text-center text-gray-400 bg-gray-800 rounded-lg shadow">Você não tem permissão para ver os tópicos desta categoria.</div>';
                showView('category');
                return;
            }
            
            topicsList.innerHTML = '<div class="loading-spinner"></div><p class="text-gray-400 text-center">Carregando tópicos...</p>';
            const q = query(topicsCol, where("categoryId", "==", categoryId)); 
            
            if (unsubscribeTopics) unsubscribeTopics();
            unsubscribeTopics = onSnapshot(q, async (snapshot) => {
                if (!currentUser || !userProfileData) return; // Check again inside snapshot
                
                const topicsToShow = [];
                snapshot.docs.forEach(doc => {
                    const topic = doc.data();
                    topic.id = doc.id;
                    let canViewThisTopic = false;
                    if (isAdmin) {
                        canViewThisTopic = true;
                    } else {
                        const topicRoles = topic.allowedRoles;
                        if (topicRoles && topicRoles.length > 0) { // Topic has specific roles
                            if (topicRoles.includes(userProfileData.role)) {
                                canViewThisTopic = true;
                            }
                        } else { // Topic inherits from category (which we've already checked)
                            canViewThisTopic = true; // If category check passed, and topic has no specific roles, it's viewable
                        }
                    }
                    if(canViewThisTopic) topicsToShow.push(topic);
                });

                if (topicsToShow.length === 0) {
                    topicsList.innerHTML = '<div class="p-6 text-center text-gray-400 bg-gray-800 rounded-lg shadow">Nenhum tópico encontrado (ou visível para você) nesta categoria.</div>';
                    showView('category');
                    return;
                }


                const userIds = new Set();
                topicsToShow.forEach(topic => {
                    if(topic.createdBy) userIds.add(topic.createdBy);
                    if(topic.lastReplyBy) userIds.add(topic.lastReplyBy);
                });

                const profiles = {};
                if (userIds.size > 0) {
                    const profilePromises = Array.from(userIds).map(uid => getDoc(doc(userProfilesCol, uid)));
                     try {
                        const profileSnaps = await Promise.all(profilePromises);
                        profileSnaps.forEach(snap => {
                            if (snap.exists()) {
                                const data = snap.data();
                                profiles[snap.id] = {
                                    displayName: data.nickname || data.displayName || data.email?.split('@')[0] || 'Desconhecido',
                                    role: data.role || 'Membro' 
                                };
                            } else {
                                profiles[snap.id] = { displayName: 'Usuário Deletado', role: 'Membro' };
                            }
                        });
                    } catch (err) { console.error("Error fetching user profiles for topics:", err); }
                }
                
                const sortedDocs = topicsToShow.sort((a,b) => { 
                    const timeA = a.lastReplyAt?.seconds || a.createdAt?.seconds || 0;
                    const timeB = b.lastReplyAt?.seconds || b.createdAt?.seconds || 0;
                    return timeB - timeA;
                });

                let topicsHtml = '';
                sortedDocs.forEach(topic => {
                    const createdByDisplayName = profiles[topic.createdBy]?.displayName || topic.userDisplayName || 'Desconhecido';
                    const lastReplyByDisplayName = profiles[topic.lastReplyBy]?.displayName || topic.lastReplyByDisplayName || 'N/A';
                    
                    let topicActionsHtml = '';
                    if (currentUser.uid === topic.createdBy || hasPermission(PERMISSIONS.MANAGE_CATEGORIES) ) {
                         topicActionsHtml += `<svg class="edit-topic-btn-icon w-4 h-4 inline-block" data-topic-id="${topic.id}" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>`;
                    }
                    if (hasPermission(PERMISSIONS.DELETE_ANY_TOPIC) || (hasPermission(PERMISSIONS.DELETE_OWN_TOPIC) && currentUser.uid === topic.createdBy)) {
                        topicActionsHtml += `<button class="delete-topic-btn text-red-500 hover:text-red-400 text-xs ml-2 self-start p-1" data-id="${topic.id}" data-title="${topic.title}">Excluir</button>`;
                    }
                    const topicPrivacyInfo = (topic.allowedRoles && topic.allowedRoles.length > 0) 
                        ? `<p class="text-xs text-yellow-400 mt-1">Privado para: ${topic.allowedRoles.join(', ')}</p>` 
                        : (currentCategoryAllowedRoles.length > 0 ? `<p class="text-xs text-yellow-400 mt-1">Privado (herdado da categoria)</p>` : `<p class="text-xs text-green-400 mt-1">Público</p>`);


                    topicsHtml += `
                        <div class="bg-gray-800 p-4 rounded-lg shadow flex justify-between items-start hover:bg-gray-700 transition-colors duration-150 topic-link-container">
                            <div class="flex-grow">
                                <h4 class="text-lg font-medium text-blue-400 hover:text-blue-300 cursor-pointer topic-title-link" data-id="${topic.id}" data-title="${topic.title}">
                                    ${topic.title}
                                </h4>
                                ${topicPrivacyInfo}
                                <p class="text-xs text-gray-500 mt-1">
                                    Criado por: <a href="#" class="text-blue-300 hover:underline user-profile-link" data-userid="${topic.createdBy}">${createdByDisplayName}</a> (${formatTimestamp(topic.createdAt)})
                                </p>
                                <p class="text-xs text-gray-500">Visualizações: ${topic.viewCount || 0} | Respostas: ${topic.replyCount || 0}</p>
                            </div>
                            <div class="text-right text-sm flex-shrink-0 ml-4 w-48">
                                <p class="truncate">Última por: <a href="#" class="text-blue-300 hover:underline user-profile-link" data-userid="${topic.lastReplyBy}">${lastReplyByDisplayName}</a></p>
                                <p class="text-xs text-gray-500">${formatTimestamp(topic.lastReplyAt)}</p>
                            </div>
                            <div class="flex flex-col items-end space-y-1 ml-2">
                                ${topicActionsHtml}
                            </div>
                        </div>
                    `;
                });
                topicsList.innerHTML = topicsHtml;
                addProfileLinkListeners(topicsList);
                // Add event listeners for edit topic buttons
                topicsList.querySelectorAll('.edit-topic-btn-icon').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        e.stopPropagation(); // Prevent topic navigation
                        const topicId = e.target.closest('.edit-topic-btn-icon').dataset.topicId;
                        const topicRef = doc(topicsCol, topicId);
                        const topicSnap = await getDoc(topicRef);
                        if (topicSnap.exists()) {
                            openEditTopicModal(topicId, topicSnap.data());
                        } else {
                            showModal("Tópico não encontrado para editar.", "error");
                        }
                    });
                });
                showView('category');
            }, (error) => {
                console.error("Error loading topics:", error);
                if(currentUser && topicsList) {
                    topicsList.innerHTML = '<div class="p-6 text-center text-red-400 bg-gray-800 rounded-lg shadow">Erro ao carregar tópicos.</div>';
                    showModal("Erro ao carregar tópicos: " + error.message);
                }
                showView('category');
            });
        }

        async function handleTopicListClick(e) {
            const target = e.target;
            if (target.classList.contains('delete-topic-btn')) {
                 e.stopPropagation();
                 const topicId = target.dataset.id;
                 const topicTitle = target.dataset.title;
                 confirmAction(`Tem certeza que deseja excluir o tópico "${topicTitle}" e todos os seus posts?`, async () => {
                    if (!db) { showModal("Serviço de banco de dados indisponível."); return; }
                    await deleteTopic(topicId);
                });
            } else if (target.classList.contains('user-profile-link')) {
                e.preventDefault();
                e.stopPropagation();
                const userIdToShow = target.dataset.userid;
                if (userIdToShow) showView('userProfile', { userId: userIdToShow });
            } else if (target.closest('.edit-topic-btn-icon')) { // Click on SVG or its path
                e.stopPropagation();
                const topicId = target.closest('.edit-topic-btn-icon').dataset.topicId;
                const topicRef = doc(topicsCol, topicId);
                const topicSnap = await getDoc(topicRef);
                if (topicSnap.exists()) {
                    openEditTopicModal(topicId, topicSnap.data());
                } else {
                    showModal("Tópico não encontrado para editar.", "error");
                }
            } else {
                const topicLink = target.closest('.topic-link-container')?.querySelector('.topic-title-link');
                if (topicLink && topicLink.dataset.id) {
                    const topicId = topicLink.dataset.id;
                    const topicTitle = topicLink.dataset.title;
                    
                    const topicRef = doc(topicsCol, topicId);
                    try { 
                        await updateDoc(topicRef, { viewCount: increment(1) });
                    } catch (viewError) {
                        console.warn("Could not update view count:", viewError.message); 
                    }
                    loadPosts(topicId, topicTitle);
                }
            }
        }

        async function deleteTopic(topicId) {
            const topicRef = doc(topicsCol, topicId);
            const topicSnap = await getDoc(topicRef);
            if (!topicSnap.exists()) {
                showModal("Tópico não encontrado.", "error"); return;
            }
            const topicData = topicSnap.data();
            if (!hasPermission(PERMISSIONS.DELETE_ANY_TOPIC) && !(hasPermission(PERMISSIONS.DELETE_OWN_TOPIC) && currentUser.uid === topicData.createdBy)) {
                showModal("Você não tem permissão para excluir este tópico.", "error"); return;
            }

            showModal("Excluindo tópico e seus posts...", "info");
            try {
                const postsInTopicQuery = query(postsCol, where("topicId", "==", topicId));
                const postsSnapshot = await getDocs(postsInTopicQuery);
                let postsDeletedCount = 0;
                for (const postDoc of postsSnapshot.docs) {
                    await deleteDoc(doc(postsCol, postDoc.id));
                    postsDeletedCount++;
                }
                await deleteDoc(topicRef);

                if (topicData.categoryId) { 
                    const categoryRef = doc(categoriesCol, topicData.categoryId); 
                    const categorySnap = await getDoc(categoryRef);
                    if (categorySnap.exists()) {
                        const categoryData = categorySnap.data();
                        let updateData = {
                            topicCount: increment(-1),
                            postCount: increment(-postsDeletedCount)
                        };
                        if (categoryData.lastActivityDetails && categoryData.lastActivityDetails.topicId === topicId) {
                            console.log("Deleted topic was last active in category. LastActivityDetails might be stale until new activity.");
                        }
                        await updateDoc(categoryRef, updateData);
                    }
                }
                showModal("Tópico excluído com sucesso!", "success");
            } catch (error) {
                console.error("Error deleting topic:", error);
                showModal("Erro ao excluir tópico: " + error.message, "error");
            }
        }

        let currentTopicId = null;
        let currentTopicTitle = '';

        async function handleCreatePost(e) {
            e.preventDefault();
            if (!hasPermission(PERMISSIONS.CREATE_POST)) {
                 showModal("Você não tem permissão para criar posts.", "error"); return;
            }
            if (!currentUser || !currentTopicId) {
                showModal("Você precisa estar logado e em um tópico para postar.");
                return;
            }
            const content = e.target.content.value.trim();
            if (!content) {
                showModal("O conteúdo da postagem não pode estar vazio.");
                return;
            }
            
            const now = Timestamp.now();
            const userDisplayName = userProfileData?.nickname || userProfileData?.displayName || currentUser.email.split('@')[0];

            try {
                await addDoc(postsCol, {
                    topicId: currentTopicId,
                    userId: currentUserId,
                    userDisplayName: userDisplayName, 
                    content,
                    createdAt: now
                });

                const topicRef = doc(topicsCol, currentTopicId);
                await updateDoc(topicRef, {
                    replyCount: increment(1),
                    postCount: increment(1), 
                    lastReplyAt: now,
                    lastReplyBy: currentUserId,
                    lastReplyByDisplayName: userDisplayName
                });
                
                if(currentCategoryId) { 
                    const categoryRef = doc(categoriesCol, currentCategoryId); 
                    await updateDoc(categoryRef, {
                        postCount: increment(1), 
                        lastActivity: now,
                        lastActivityDetails: {
                            topicId: currentTopicId,
                            topicTitle: currentTopicTitle, 
                            userId: currentUserId,
                            userDisplayName: userDisplayName,
                            timestamp: now
                        }
                    });
                }
                showModal("Postagem criada com sucesso!", "success");
                e.target.reset();
            } catch (error) {
                console.error("Error creating post:", error);
                showModal("Erro ao criar postagem: " + error.message);
            }
        }

        async function loadPosts(topicId, topicTitleFromLink) {
            if (!db || !postsCol || !userProfilesCol || !topicsCol || !postsList || !topicTitleFull) { 
                if(postsList) postsList.innerHTML = '<div class="p-4 text-center text-red-400">Erro: Serviço de banco de dados indisponível.</div>';
                showView('topic');
                return; 
            }
            if (!currentUser || !userProfileData) { showView('login'); return; } // Ensure profile data for permission checks

            showView('loading');
            currentTopicId = topicId; // Set for creating new posts
            
            const topicRef = doc(topicsCol, topicId);
            const topicSnap = await getDoc(topicRef);

            if (!topicSnap.exists()) {
                showModal("Tópico não encontrado.", "error");
                showView('category'); 
                return;
            }
            const topicData = topicSnap.data();
            currentTopicTitle = topicData.title; // Use title from DB for consistency
            topicTitleFull.textContent = currentTopicTitle;


            // Permission check for the topic itself
            let canViewThisTopic = false;
            if (isAdmin) {
                canViewThisTopic = true;
            } else {
                const topicSpecificRoles = topicData.allowedRoles;
                if (topicSpecificRoles && topicSpecificRoles.length > 0) {
                    if (userProfileData && topicSpecificRoles.includes(userProfileData.role)) {
                        canViewThisTopic = true;
                    }
                } else { // Topic inherits from category
                    // currentCategoryAllowedRoles should have been set when navigating to the category
                    // If navigating directly, fetch category to get its roles
                    let categoryAllowedRolesForTopic = currentCategoryAllowedRoles; // Use if already set
                    if (topicData.categoryId && (!currentCategoryId || currentCategoryId !== topicData.categoryId)) {
                        const parentCategoryRef = doc(categoriesCol, topicData.categoryId);
                        const parentCategorySnap = await getDoc(parentCategoryRef);
                        if (parentCategorySnap.exists()) {
                            categoryAllowedRolesForTopic = parentCategorySnap.data().allowedRoles || [];
                            currentCategoryName = parentCategorySnap.data().name; // Update breadcrumb info
                            currentCategoryId = topicData.categoryId;
                        } else {
                             categoryAllowedRolesForTopic = []; // Category not found, assume restricted
                        }
                    }
                    
                    if (categoryAllowedRolesForTopic.length === 0 || (userProfileData && categoryAllowedRolesForTopic.includes(userProfileData.role))) {
                        canViewThisTopic = true;
                    }
                }
            }

            if (!canViewThisTopic) {
                showModal("Você não tem permissão para visualizar este tópico.", "error");
                showView(currentCategoryId ? 'category' : 'forumHome'); // Go back to category or home
                return;
            }
            
            // Update breadcrumbs after confirming category details
            updateBreadcrumbs([
                {name: currentCategoryName || "Categoria", view: 'category', id: currentCategoryId}, 
                {name: currentTopicTitle, view: 'topic', id: topicId}
            ]);


            if (document.getElementById('topic-poll-container')) document.getElementById('topic-poll-container').innerHTML = ''; 

            postsList.innerHTML = '<div class="loading-spinner"></div><p class="text-gray-400 text-center">Carregando postagens...</p>';
            const q = query(postsCol, where("topicId", "==", topicId)); 

            if(unsubscribePosts) unsubscribePosts();
            unsubscribePosts = onSnapshot(q, async (snapshot) => {
                if (!currentUser) return;
                if (snapshot.empty) {
                    // Topic exists (checked above), so it's just empty of posts
                    postsList.innerHTML = '<div class="p-6 text-center text-gray-400 bg-gray-800 rounded-lg shadow">Nenhuma postagem encontrada neste tópico. Seja o primeiro a responder!</div>';
                    showView('topic');
                    return;
                }

                const userIds = new Set(snapshot.docs.map(d => d.data().userId).filter(id => id));
                const profiles = {};
                 if (userIds.size > 0) {
                    const profilePromises = Array.from(userIds).map(uid => getDoc(doc(userProfilesCol, uid)));
                     try {
                        const profileSnaps = await Promise.all(profilePromises);
                        profileSnaps.forEach(snap => {
                            if (snap.exists()) {
                                const data = snap.data();
                                profiles[snap.id] = {
                                    displayName: data.nickname || data.displayName || data.email?.split('@')[0] || 'Desconhecido',
                                    role: data.role || 'Membro'
                                };
                            } else {
                                profiles[snap.id] = { displayName: 'Usuário Deletado', role: 'Membro' };
                            }
                        });
                    } catch (err) { console.error("Error fetching user profiles for posts:", err); }
                }
                
                const docsToSort = [...snapshot.docs];
                const sortedDocs = docsToSort.sort((a,b) => {
                    const timeA = a.data().createdAt?.seconds || 0;
                    const timeB = b.data().createdAt?.seconds || 0;
                    return timeA - timeB; 
                });

                let postsHtml = '';
                sortedDocs.forEach((postDoc, index) => { 
                    const post = postDoc.data();
                    const userProfile = profiles[post.userId];
                    const displayName = userProfile?.displayName || post.userDisplayName || 'Desconhecido';
                    const userRole = userProfile?.role || 'Membro'; 
                    const roleColor = currentRoleColors[userRole] || '#6b7280'; 
                    const postContent = post.content ? post.content.replace(/\n/g, '<br>') : ""; 

                    let commandButtonHtml = '';
                    if (index === 0 && post.commandToCopy) { 
                        commandButtonHtml = `<button class="copy-post-command-btn bg-indigo-500 hover:bg-indigo-600 text-white text-xs py-1 px-2 rounded-md mt-2" data-command="${post.commandToCopy}">Copiar Comando</button>`;
                    }
                    
                    let actionsHtml = '';
                    if (hasPermission(PERMISSIONS.EDIT_ANY_POST) || (hasPermission(PERMISSIONS.EDIT_OWN_POST) && currentUser.uid === post.userId)) {
                        actionsHtml += `<button class="edit-post-btn text-yellow-500 hover:text-yellow-400 text-xs mt-2 p-1 mr-2" data-post-id="${postDoc.id}">Editar</button>`;
                    }
                    if (hasPermission(PERMISSIONS.DELETE_ANY_POST) || (hasPermission(PERMISSIONS.DELETE_OWN_POST) && currentUser.uid === post.userId)) { 
                         actionsHtml += `<button class="delete-post-btn text-red-500 hover:text-red-400 text-xs mt-2 p-1" data-id="${postDoc.id}" data-topic-id="${post.topicId}">Excluir</button>`;
                    }

                    postsHtml += `
                        <div class="bg-gray-800 p-4 rounded-lg shadow mb-4">
                            <div class="flex justify-between items-start mb-2">
                                <p class="text-sm text-blue-400 font-semibold">
                                    <a href="#" class="user-profile-link hover:underline" data-userid="${post.userId}">${displayName}</a>
                                    <span class="role-tag" style="background-color: ${roleColor};">${userRole}</span>
                                </p>
                                <p class="text-xs text-gray-500">${formatTimestamp(post.createdAt)} ${post.lastEditedAt ? `(editado ${formatTimestamp(post.lastEditedAt)})` : ''}</p>
                            </div>
                            <div id="post-content-${postDoc.id}" class="text-gray-300">${postContent}</div>
                            ${commandButtonHtml}
                            <div class="mt-2">${actionsHtml}</div>
                        </div>
                    `;
                });
                postsList.innerHTML = postsHtml;
                addProfileLinkListeners(postsList);
                postsList.querySelectorAll('.copy-post-command-btn').forEach(button => {
                    button.addEventListener('click', (e) => copyToClipboard(e.target.dataset.command));
                });
                postsList.querySelectorAll('.edit-post-btn').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const postId = e.target.dataset.postId;
                        const postRef = doc(postsCol, postId);
                        const postSnap = await getDoc(postRef);
                        if (postSnap.exists()) {
                            openEditPostModal(postId, postSnap.data().content);
                        } else {
                            showModal("Post não encontrado para editar.", "error");
                        }
                    });
                });
                showView('topic');
            }, (error) => {
                console.error("Error loading posts:", error);
                if (currentUser && postsList) {
                    postsList.innerHTML = '<div class="p-6 text-center text-red-400 bg-gray-800 rounded-lg shadow">Erro ao carregar postagens.</div>';
                    showModal("Erro ao carregar postagens: " + error.message);
                }
                showView('topic');
            });
        }

        async function handlePostListClick(e) {
            if (e.target.classList.contains('delete-post-btn')) {
                const postId = e.target.dataset.id;
                const postRef = doc(postsCol, postId);
                const postSnap = await getDoc(postRef); 
                if (!postSnap.exists()) {
                    showModal("Post não encontrado.", "error"); return;
                }
                const postData = postSnap.data();
                if (!hasPermission(PERMISSIONS.DELETE_ANY_POST) && !(hasPermission(PERMISSIONS.DELETE_OWN_POST) && currentUser.uid === postData.userId)) {
                    showModal("Você não tem permissão para excluir este post.", "error"); return;
                }

                confirmAction("Tem certeza que deseja excluir este post?", async () => {
                    try {
                        await deleteDoc(postRef); 
                        if (postData.topicId) {
                            const topicRef = doc(topicsCol, postData.topicId);
                            await updateDoc(topicRef, { 
                                replyCount: increment(-1),
                                postCount: increment(-1) 
                            });
                        }
                        if(currentCategoryId) { 
                            const categoryRef = doc(categoriesCol, currentCategoryId);
                            await updateDoc(categoryRef, { postCount: increment(-1) });
                        }
                        showModal("Post excluído com sucesso!", "success");
                    } catch (error) {
                        console.error("Error deleting post:", error);
                        showModal("Erro ao excluir post: " + error.message, "error");
                    }
                });
            } else if (e.target.classList.contains('user-profile-link')) {
                e.preventDefault();
                const userIdToShow = e.target.dataset.userid;
                if (userIdToShow) showView('userProfile', { userId: userIdToShow });
            }
        }
        
        function addProfileLinkListeners(parentElement) {
            if (!parentElement) return;
            parentElement.querySelectorAll('.user-profile-link').forEach(link => {
                const newLink = link.cloneNode(true);
                link.parentNode.replaceChild(newLink, link);

                newLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    const userIdToShow = e.target.dataset.userid;
                    if (userIdToShow) showView('userProfile', { userId: userIdToShow });
                });
            });
        }

        function openEditPostModal(postId, currentContent) {
            if (!editPostModal || !editPostContentInput) return;
            editingPostId = postId; // Ensure this is declared globally
            editPostContentInput.value = currentContent; 
            editPostModal.style.display = 'flex';
        }

        async function saveEditedPost() {
            if (!editingPostId || !editPostContentInput || !editPostModal) return;
            const postRef = doc(postsCol, editingPostId);
            const postSnap = await getDoc(postRef);
            if (!postSnap.exists()) {
                showModal("Post não encontrado para editar.", "error"); return;
            }
            const postData = postSnap.data();

            if (!hasPermission(PERMISSIONS.EDIT_ANY_POST) && !(hasPermission(PERMISSIONS.EDIT_OWN_POST) && currentUser.uid === postData.userId)) {
                showModal("Você não tem permissão para editar este post.", "error"); return;
            }

            const newContent = editPostContentInput.value.trim();
            if (!newContent) {
                showModal("O conteúdo do post não pode ficar vazio.", "error");
                return;
            }
            try {
                await updateDoc(postRef, {
                    content: newContent,
                    lastEditedAt: Timestamp.now(),
                    lastEditedBy: currentUserId, 
                    lastEditedByDisplayName: userProfileData?.nickname || userProfileData?.displayName || currentUser.email.split('@')[0]
                });
                showModal("Post atualizado com sucesso!", "success");
                editPostModal.style.display = 'none';
                editingPostId = null;
            } catch (error) {
                console.error("Error updating post:", error);
                showModal("Erro ao atualizar post: " + error.message, "error");
            }
        }

        function openEditTopicModal(topicId, currentTopic) {
            if (!editTopicModal || !editTopicTitleInput || !editTopicRolePermissionsContainer) return;
            editingTopicId = topicId;
            editingTopicData = currentTopic; // Store the full topic data

            editTopicTitleInput.value = currentTopic.title || '';
            populateTopicRolePermissionsCheckboxes(editTopicRolePermissionsContainer, currentTopic.allowedRoles || []);
            editTopicModal.style.display = 'flex';
        }

        async function saveEditedTopic() {
            if (!editingTopicId || !editingTopicData || !editTopicTitleInput || !editTopicRolePermissionsContainer || !editTopicModal) return;

            // Permission check: Topic creator or someone with MANAGE_CATEGORIES
            if (!(currentUser.uid === editingTopicData.createdBy || hasPermission(PERMISSIONS.MANAGE_CATEGORIES))) {
                showModal("Você não tem permissão para editar este tópico.", "error");
                return;
            }

            const newTitle = editTopicTitleInput.value.trim();
            if (!newTitle) {
                showModal("O título do tópico não pode ficar vazio.", "error");
                return;
            }

            const selectedRoles = [];
            const checkboxes = document.querySelectorAll('#edit-topic-role-permissions-container input[name="topicAllowedRoles"]:checked');
            checkboxes.forEach(checkbox => selectedRoles.push(checkbox.value));

            try {
                const topicRef = doc(topicsCol, editingTopicId);
                await updateDoc(topicRef, {
                    title: newTitle,
                    allowedRoles: selectedRoles.length > 0 ? selectedRoles : [] // Store empty array if none selected
                });
                showModal("Tópico atualizado com sucesso!", "success");
                editTopicModal.style.display = 'none';
                editingTopicId = null;
                editingTopicData = null;
                // The topics list will refresh via its onSnapshot listener
            } catch (error) {
                console.error("Error updating topic:", error);
                showModal("Erro ao atualizar tópico: " + error.message, "error");
            }
        }


        // --- Gemini API Integration ---
        async function callGeminiAPI(prompt, loadingElementId) {
            const loadingSpinner = document.getElementById(loadingElementId);
            if (loadingSpinner) loadingSpinner.style.display = 'inline-block';

            let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = { contents: chatHistory };
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: { message: "Resposta não JSON da API." }}));
                    console.error("Gemini API Error Response:", errorData);
                    throw new Error(`Erro da API Gemini: ${response.status} ${response.statusText}. Detalhes: ${JSON.stringify(errorData.error?.message || errorData)}`);
                }
                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    console.warn("Resposta inesperada da API Gemini:", result);
                    throw new Error("Resposta inesperada da API Gemini ou conteúdo ausente.");
                }
            } catch (error) {
                console.error("Falha ao chamar a API Gemini:", error);
                showModal("Falha ao comunicar com a IA: " + error.message, "error");
                return null;
            } finally {
                if (loadingSpinner) loadingSpinner.style.display = 'none';
            }
        }

        async function generateCategoryDescription() {
            if (!categoryNameInput || !categoryDescriptionInput) return;
            const categoryName = categoryNameInput.value.trim();
            if (!categoryName) {
                showModal("Por favor, insira um nome para a categoria primeiro.", "error");
                return;
            }
            const prompt = `Gere uma descrição curta e concisa (máximo 2 frases) para uma categoria de fórum chamada "${categoryName}". A descrição deve ser convidativa e em português do Brasil.`;
            const generatedDescription = await callGeminiAPI(prompt, 'generate-category-desc-spinner');
            if (generatedDescription) {
                categoryDescriptionInput.value = generatedDescription.trim();
                showModal("Descrição gerada pela IA!", "success");
            }
        }

        async function suggestTopicTitle() {
            if (!newTopicContentInput || !newTopicTitleInput) return;
            const topicContent = newTopicContentInput.value.trim();
            if (!topicContent) {
                showModal("Por favor, escreva o conteúdo da primeira postagem primeiro.", "error");
                return;
            }
            const prompt = `Sugira um título curto e chamativo (máximo 10 palavras) para um tópico de fórum cujo primeiro post tem o seguinte conteúdo (em português do Brasil):\n\n"${topicContent.substring(0, 500)}${topicContent.length > 500 ? '...' : ''}"\n\nO título deve ser em português do Brasil.`;
            const suggestedTitle = await callGeminiAPI(prompt, 'suggest-topic-title-spinner');
            if (suggestedTitle) {
                newTopicTitleInput.value = suggestedTitle.replace(/"/g, '').trim(); 
                showModal("Título sugerido pela IA!", "success");
            }
        }
        
        // --- Profile Management ---
        function loadMyProfileView() {
            if (!currentUser || !userProfileData || !myProfileNicknameInput || !myProfileSteamUrlInput || !myProfileEmailDisplay || !myProfileRoleDisplay) {
                showModal("Você precisa estar logado para ver seu perfil.", "error");
                showView('login');
                return;
            }
            myProfileNicknameInput.value = userProfileData.nickname || '';
            myProfileSteamUrlInput.value = userProfileData.steamProfileUrl || '';
            myProfileEmailDisplay.textContent = currentUser.email; 
            myProfileRoleDisplay.textContent = userProfileData.role || 'Membro';
            const roleColor = currentRoleColors[userProfileData.role] || '#6b7280';
            myProfileRoleDisplay.style.backgroundColor = roleColor;
            if (!myProfileRoleDisplay.classList.contains('role-tag')) {
                myProfileRoleDisplay.classList.add('role-tag');
            }
        }

        async function saveMyProfile() {
            if (!currentUser || !db || !myProfileNicknameInput || !myProfileSteamUrlInput) {
                showModal("Não foi possível salvar o perfil. Tente novamente.", "error");
                return;
            }
            const newNickname = myProfileNicknameInput.value.trim();
            const newSteamUrl = myProfileSteamUrlInput.value.trim();

            const profileRef = doc(userProfilesCol, currentUserId);
            try {
                await updateDoc(profileRef, {
                    nickname: newNickname,
                    steamProfileUrl: newSteamUrl,
                });
                showModal("Perfil atualizado com sucesso!", "success");
            } catch (error) {
                console.error("Error updating profile:", error);
                showModal("Erro ao atualizar perfil: " + error.message, "error");
            }
        }

        async function loadUserProfileView(userId) {
            if (!db || !userProfilesCol || !userProfileViewDisplayName) { 
                 showModal("Serviço de banco de dados indisponível ou UI não pronta."); return;
            }
            showView('loading'); 
            const profileRef = doc(userProfilesCol, userId);
            try {
                const docSnap = await getDoc(profileRef);
                if (docSnap.exists()) {
                    const profile = docSnap.data();
                    userProfileViewDisplayName.textContent = profile.displayName || 'N/A';
                    userProfileViewNickname.textContent = profile.nickname || 'Nenhum';
                    const canViewFullEmail = hasPermission(PERMISSIONS.MANAGE_USERS) || currentUserId === userId;
                    userProfileViewEmail.textContent = canViewFullEmail ? profile.email : (profile.email ? profile.email.split('@')[0] + '@...' : 'N/A');
                    
                    userProfileViewRole.textContent = profile.role || 'Membro';
                    const roleColor = currentRoleColors[profile.role] || '#6b7280';
                    userProfileViewRole.style.backgroundColor = roleColor;
                    if (!userProfileViewRole.classList.contains('role-tag')) {
                         userProfileViewRole.classList.add('role-tag');
                    }

                    if (profile.steamProfileUrl && userProfileViewSteamLink) {
                        userProfileViewSteamLink.href = profile.steamProfileUrl;
                        userProfileViewSteamLink.textContent = profile.steamProfileUrl;
                        userProfileViewSteamLink.parentElement.style.display = 'block';
                    } else if (userProfileViewSteamLink) {
                        userProfileViewSteamLink.parentElement.style.display = 'none';
                    }
                    if(userProfileViewRegisteredDate) userProfileViewRegisteredDate.textContent = formatTimestamp(profile.createdAt);
                    showView('userProfile'); 
                } else {
                    showModal("Perfil de usuário não encontrado.", "error");
                    showView('forumHome'); 
                }
            } catch (error) {
                console.error("Error loading user profile:", error);
                showModal("Erro ao carregar perfil: " + error.message, "error");
                showView('forumHome'); 
            }
        }
        
        // --- Role Color & Server/Permissions Config ---
        async function loadRoleColorSettings() { 
            if (!db || !serverConfigDocRef || !hasPermission(PERMISSIONS.MANAGE_FORUM_SETTINGS) || !adminRoleColorSettings) return;
            adminRoleColorSettings.innerHTML = '<p class="text-gray-400">Carregando configurações de cores...</p>';
            try {
                let html = '';
                defaultRoles.forEach(role => {
                    html += `
                        <div class="flex items-center space-x-2 mb-2">
                            <label for="role-color-${role}" class="w-24">${role}:</label>
                            <input type="color" id="role-color-${role}" value="${currentRoleColors[role] || '#6b7280'}" class="h-8 w-12 p-0 border-none rounded">
                            <input type="text" id="role-hex-${role}" value="${currentRoleColors[role] || '#6b7280'}" placeholder="#RRGGBB" class="p-1 bg-gray-600 border border-gray-500 rounded-md text-gray-100 w-24">
                        </div>
                    `;
                });
                adminRoleColorSettings.innerHTML = html;

                defaultRoles.forEach(role => {
                    const colorPicker = document.getElementById(`role-color-${role}`);
                    const hexInput = document.getElementById(`role-hex-${role}`);
                    if (colorPicker && hexInput) {
                        colorPicker.addEventListener('input', (e) => hexInput.value = e.target.value);
                        hexInput.addEventListener('input', (e) => {
                            if (/^#[0-9A-F]{6}$/i.test(e.target.value)) { 
                                colorPicker.value = e.target.value;
                            }
                        });
                    }
                });

            } catch (error) { 
                console.error("Error displaying role color settings (should be from live config):", error);
                adminRoleColorSettings.innerHTML = '<p class="text-red-400">Erro ao carregar cores.</p>';
            }
        }

        async function saveRoleColors() {
            if (!hasPermission(PERMISSIONS.MANAGE_FORUM_SETTINGS)) { 
                 showModal("Você não tem permissão para gerenciar configurações.", "error"); return;
            }
            const newRoleColors = {};
            let allValid = true;
            defaultRoles.forEach(role => {
                const hexValue = document.getElementById(`role-hex-${role}`).value.trim();
                if (/^#[0-9A-F]{6}$/i.test(hexValue)) {
                    newRoleColors[role] = hexValue;
                } else {
                    showModal(`Cor inválida para ${role}: ${hexValue}. Use formato #RRGGBB.`, "error");
                    allValid = false;
                }
            });

            if (!allValid) return;

            try {
                await setDoc(serverConfigDocRef, { roleColors: newRoleColors }, { merge: true });
                showModal("Cores dos cargos salvas com sucesso!", "success");
            } catch (error) {
                console.error("Error saving role colors:", error);
                showModal("Erro ao salvar cores: " + error.message, "error");
            }
        }
        
        async function loadServerConfig() { 
            return new Promise((resolve, reject) => {
                if (!db || !serverConfigDocRef) {
                    console.warn("loadServerConfig: DB or serverConfigDocRef not available. Using hardcoded defaults.");
                    currentRoleColors = { Admin: "#FF0000", Moderador: "#00FF00", VIP: "#0000FF", Membro: "#808080" };
                    registrationsOpen = true;
                    serverRolePermissionsConfig = { Admin: Object.fromEntries(Object.values(PERMISSIONS).map(p => [p, true])) };
                     defaultRoles.forEach(role => { 
                        if (!serverRolePermissionsConfig[role]) serverRolePermissionsConfig[role] = {};
                        if (role === 'Membro' && Object.keys(serverRolePermissionsConfig[role]).length === 0) {
                             serverRolePermissionsConfig[role][PERMISSIONS.CREATE_TOPIC] = true;
                             serverRolePermissionsConfig[role][PERMISSIONS.CREATE_POST] = true;
                             serverRolePermissionsConfig[role][PERMISSIONS.EDIT_OWN_POST] = true;
                             serverRolePermissionsConfig[role][PERMISSIONS.DELETE_OWN_POST] = true;
                             serverRolePermissionsConfig[role][PERMISSIONS.DELETE_OWN_TOPIC] = true;
                        }
                    });
                    if (userProfileData && userProfileData.role) {
                        currentRolePermissions = serverRolePermissionsConfig[userProfileData.role] || {};
                    } else {
                        currentRolePermissions = {};
                    }
                    resolve();
                    return;
                }

                if (unsubscribeServerConfig) unsubscribeServerConfig();
                let initialLoadDone = false;

                unsubscribeServerConfig = onSnapshot(serverConfigDocRef, (docSnap) => {
                    let configData = {};
                    if (docSnap.exists()) {
                        configData = docSnap.data();
                    } else { 
                        console.log("Server config not found in Firestore, using defaults and attempting to create.");
                        configData = {
                            forumName: "Negativa Server - Fórum",
                            registrationsOpen: true,
                            roleColors: { Admin: "#D32F2F", Moderador: "#1976D2", VIP: "#7B1FA2", Membro: "#616161" }, 
                            rolePermissions: {}, 
                            csServers: []
                        };
                        defaultRoles.forEach(role => {
                            configData.rolePermissions[role] = {};
                            if (role === 'Admin') {
                                Object.values(PERMISSIONS).forEach(perm => configData.rolePermissions[role][perm] = true);
                            } else if (role === 'Membro') {
                                configData.rolePermissions[role][PERMISSIONS.CREATE_TOPIC] = true;
                                configData.rolePermissions[role][PERMISSIONS.CREATE_POST] = true;
                                configData.rolePermissions[role][PERMISSIONS.EDIT_OWN_POST] = true;
                                configData.rolePermissions[role][PERMISSIONS.DELETE_OWN_POST] = true;
                                configData.rolePermissions[role][PERMISSIONS.DELETE_OWN_TOPIC] = true;
                            }
                        });
                        setDoc(serverConfigDocRef, configData)
                            .then(() => console.log("Default server config saved to Firestore."))
                            .catch(err => console.error("Error saving default server config:", err));
                    }

                    currentRoleColors = configData.roleColors || { Admin: "#D32F2F", Moderador: "#1976D2", VIP: "#7B1FA2", Membro: "#616161" };
                    registrationsOpen = configData.registrationsOpen === undefined ? true : configData.registrationsOpen;
                    serverRolePermissionsConfig = configData.rolePermissions || {};
                    
                    if (Object.keys(serverRolePermissionsConfig).length === 0) {
                         defaultRoles.forEach(role => {
                            serverRolePermissionsConfig[role] = {};
                            if (role === 'Admin') {
                                Object.values(PERMISSIONS).forEach(perm => serverRolePermissionsConfig[role][perm] = true);
                            } else if (role === 'Membro') {
                                serverRolePermissionsConfig[role][PERMISSIONS.CREATE_TOPIC] = true;
                                serverRolePermissionsConfig[role][PERMISSIONS.CREATE_POST] = true;
                                serverRolePermissionsConfig[role][PERMISSIONS.EDIT_OWN_POST] = true;
                                serverRolePermissionsConfig[role][PERMISSIONS.DELETE_OWN_POST] = true;
                                serverRolePermissionsConfig[role][PERMISSIONS.DELETE_OWN_TOPIC] = true;
                            }
                        });
                    }


                    if (userProfileData && userProfileData.role) {
                        currentRolePermissions = serverRolePermissionsConfig[userProfileData.role] || {};
                    }

                    if (forumTitleHeader) forumTitleHeader.textContent = configData.forumName || "Negativa Server - Fórum";
                    if (forumTitleTag) forumTitleTag.textContent = configData.forumName || "Negativa Server - Fórum";
                    loadPublicCsServerBanners(configData.csServers || []); 

                    if (registerNav) registerNav.style.display = registrationsOpen ? 'inline-block' : 'none';
                    if (adminRegistrationsToggle && isAdmin) adminRegistrationsToggle.checked = registrationsOpen; 

                    if (isAdmin && adminControls && adminControls.style.display === 'block') {
                        loadRolePermissionsSettings(); 
                        loadRoleColorSettings(); 
                        populateCategoryRolePermissionsCheckboxes(); 
                        populateTopicRolePermissionsCheckboxes(topicRolePermissionsContainer);
                    }
                    console.log("[Client] Server config loaded/updated via listener. Reg Open:", registrationsOpen);

                    if (!initialLoadDone) {
                        initialLoadDone = true;
                        resolve();
                    }
                }, (error) => {
                    console.error("Error loading server config:", error);
                    currentRoleColors = { Admin: "#D32F2F", Moderador: "#1976D2", VIP: "#7B1FA2", Membro: "#616161" };
                    registrationsOpen = true;
                    serverRolePermissionsConfig = { Admin: Object.fromEntries(Object.values(PERMISSIONS).map(p => [p, true])) };
                     defaultRoles.forEach(role => {
                        if (!serverRolePermissionsConfig[role]) serverRolePermissionsConfig[role] = {};
                         if (role === 'Membro' && Object.keys(serverRolePermissionsConfig[role]).length === 0) {
                             serverRolePermissionsConfig[role][PERMISSIONS.CREATE_TOPIC] = true;
                         }
                    });
                    if (userProfileData && userProfileData.role) {
                        currentRolePermissions = serverRolePermissionsConfig[userProfileData.role] || {};
                    }
                    if (!initialLoadDone) {
                        initialLoadDone = true;
                        reject(error); 
                    }
                });
            });
        }
        
        async function loadRecentMembers() {
            if (!db || !userProfilesCol || !recentMembersList) {
                if(recentMembersList) recentMembersList.innerHTML = '<p class="text-xs text-gray-500">Não foi possível carregar.</p>';
                return;
            }
            if (unsubscribeRecentMembers) unsubscribeRecentMembers();

            const q = query(userProfilesCol, orderBy("lastSeen", "desc"), limit(5));
            unsubscribeRecentMembers = onSnapshot(q, (snapshot) => {
                if (!currentUser && !registrationsOpen) { 
                     recentMembersList.innerHTML = ''; return;
                }
                if (snapshot.empty) {
                    recentMembersList.innerHTML = '<p class="text-xs text-gray-500">Nenhum membro online recentemente.</p>';
                    return;
                }
                let membersHtml = '<h4 class="text-md font-semibold text-gray-300 mb-2">Online Recentemente:</h4><ul class="space-y-1">';
                snapshot.forEach(doc => {
                    const member = doc.data();
                    const displayName = member.nickname || member.displayName || member.email?.split('@')[0] || 'Usuário';
                    const roleColor = currentRoleColors[member.role] || '#6b7280';
                    membersHtml += `
                        <li class="text-xs">
                            <a href="#" class="user-profile-link text-blue-400 hover:underline" data-userid="${doc.id}">${displayName}</a>
                            <span class="role-tag" style="background-color: ${roleColor};">${member.role || 'Membro'}</span>
                            <span class="text-gray-500 ml-1">(${formatTimestamp(member.lastSeen)})</span>
                        </li>`;
                });
                membersHtml += '</ul>';
                recentMembersList.innerHTML = membersHtml;
                addProfileLinkListeners(recentMembersList);
            }, (error) => {
                console.error("Error loading recent members:", error);
                if(recentMembersList) recentMembersList.innerHTML = '<p class="text-xs text-red-500">Erro ao carregar membros.</p>';
            });
        }

        // --- Chat Functionality ---
        async function sendChatMessage() {
            if (!currentUser || !db || !chatMessagesCol || !chatMessageInput) {
                showModal("Você precisa estar logado para enviar mensagens no chat.", "error");
                return;
            }
            const messageText = chatMessageInput.value.trim();
            if (!messageText) return;

            const userDisplayName = userProfileData?.nickname || userProfileData?.displayName || currentUser.email.split('@')[0];
            const userRole = userProfileData?.role || 'Membro';

            try {
                await addDoc(chatMessagesCol, {
                    userId: currentUserId,
                    displayName: userDisplayName,
                    role: userRole,
                    text: messageText,
                    timestamp: Timestamp.now()
                });
                chatMessageInput.value = '';
            } catch (error) {
                console.error("Error sending chat message:", error);
                showModal("Erro ao enviar mensagem: " + error.message, "error");
            }
        }

        async function loadChatMessages() {
            if (!db || !chatMessagesCol || !chatMessagesContainer) {
                if (chatMessagesContainer) chatMessagesContainer.innerHTML = '<p class="text-xs text-gray-500">Chat indisponível.</p>';
                return;
            }
            if (unsubscribeChatMessages) unsubscribeChatMessages();

            const q = query(chatMessagesCol, orderBy("timestamp", "desc"), limit(30));
            unsubscribeChatMessages = onSnapshot(q, async (snapshot) => {
                 if (!currentUser && !registrationsOpen) { 
                     chatMessagesContainer.innerHTML = ''; return;
                 }

                const messages = [];
                snapshot.forEach(doc => messages.push({ id: doc.id, ...doc.data() }));
                messages.reverse(); 

                chatMessagesContainer.innerHTML = '';
                if (messages.length === 0) {
                    chatMessagesContainer.innerHTML = '<p class="text-xs text-gray-500 text-center">Nenhuma mensagem ainda. Seja o primeiro!</p>';
                } else {
                    messages.forEach(msg => {
                        const roleColor = currentRoleColors[msg.role] || '#6b7280';
                        const messageDiv = document.createElement('div');
                        messageDiv.className = 'chat-message text-xs';

                        let deleteButtonHtml = '';
                        if (hasPermission(PERMISSIONS.MODERATE_CHAT) || (currentUser && msg.userId === currentUser.uid)) { 
                            deleteButtonHtml = `<button class="delete-chat-msg-btn" data-msg-id="${msg.id}" title="Apagar mensagem">X</button>`;
                        }
                        const sanitizedText = msg.text.replace(/</g, "&lt;").replace(/>/g, "&gt;");

                        messageDiv.innerHTML = `
                            <div>
                                <span class="username user-profile-link cursor-pointer hover:underline" data-userid="${msg.userId}" style="color: ${roleColor};">${msg.displayName}</span>:
                                <span>${sanitizedText}</span>
                            </div>
                            ${deleteButtonHtml}
                        `;
                        chatMessagesContainer.appendChild(messageDiv);
                    });
                    addProfileLinkListeners(chatMessagesContainer);
                    chatMessagesContainer.querySelectorAll('.delete-chat-msg-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const msgId = e.target.dataset.msgId;
                            const messageToDelete = messages.find(m => m.id === msgId);
                            if (hasPermission(PERMISSIONS.MODERATE_CHAT) && messageToDelete && messageToDelete.userId !== currentUserId) {
                                confirmAction("Tem certeza que deseja apagar esta mensagem do chat?", () => deleteChatMessage(msgId));
                            } else if (messageToDelete && messageToDelete.userId === currentUserId) { 
                                deleteChatMessage(msgId);
                            }
                        });
                    });
                    chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight; 
                }

                if (snapshot.docs.length >= 30) { 
                    const allMessagesQuery = query(chatMessagesCol, orderBy("timestamp", "asc")); 
                    const allMessagesSnap = await getDocs(allMessagesQuery);
                    if (allMessagesSnap.docs.length > 50) { 
                        const messagesToDelete = allMessagesSnap.docs.slice(0, allMessagesSnap.docs.length - 30); 
                        for (const docToDelete of messagesToDelete) {
                            try {
                                await deleteDoc(doc(chatMessagesCol, docToDelete.id));
                            } catch (delError) {
                                console.warn("Error pruning old chat message:", delError);
                            }
                        }
                    }
                }

            }, (error) => {
                console.error("Error loading chat messages:", error);
                if(chatMessagesContainer) chatMessagesContainer.innerHTML = '<p class="text-xs text-red-500">Erro ao carregar chat.</p>';
            });
        }
        
        async function deleteChatMessage(messageId) {
            try {
                await deleteDoc(doc(chatMessagesCol, messageId));
            } catch (error) {
                console.error("Error deleting chat message:", error);
                showModal("Erro ao apagar mensagem do chat: " + error.message, "error");
            }
        }
        
        function loadRolePermissionsSettings() { 
            if (!db || !serverConfigDocRef || !hasPermission(PERMISSIONS.MANAGE_ROLES_PERMISSIONS) || !adminPermissionsSettings) {
                if(adminPermissionsSettings) adminPermissionsSettings.innerHTML = ''; 
                return;
            }
            adminPermissionsSettings.innerHTML = '<p class="text-gray-400">Carregando permissões...</p>';
            
            const permissionLabels = {
                [PERMISSIONS.MANAGE_FORUM_SETTINGS]: "Gerenciar Config. Fórum",
                [PERMISSIONS.MANAGE_USERS]: "Gerenciar Usuários",
                [PERMISSIONS.MANAGE_CATEGORIES]: "Gerenciar Categorias",
                [PERMISSIONS.CREATE_TOPIC]: "Criar Tópicos",
                [PERMISSIONS.DELETE_OWN_TOPIC]: "Deletar Próprios Tópicos",
                [PERMISSIONS.DELETE_ANY_TOPIC]: "Deletar Qualquer Tópico",
                [PERMISSIONS.CREATE_POST]: "Criar Posts",
                [PERMISSIONS.EDIT_OWN_POST]: "Editar Próprios Posts",
                [PERMISSIONS.EDIT_ANY_POST]: "Editar Qualquer Post",
                [PERMISSIONS.DELETE_OWN_POST]: "Deletar Próprios Posts",
                [PERMISSIONS.DELETE_ANY_POST]: "Deletar Qualquer Post",
                [PERMISSIONS.MODERATE_CHAT]: "Moderar Chat",
                [PERMISSIONS.MANAGE_ROLES_PERMISSIONS]: "Gerenciar Permissões de Cargos"
            };

            let html = '<div class="space-y-4">';
            defaultRoles.forEach(role => {
                if (role === 'Admin') return; 

                html += `<div class="bg-gray-700 p-3 rounded-md">
                            <h5 class="text-md font-semibold text-blue-300 mb-2">${role}</h5>
                            <div class="grid grid-cols-2 sm:grid-cols-3 gap-2">`;
                Object.keys(PERMISSIONS).forEach(permKey => {
                    const permValue = PERMISSIONS[permKey];
                    if (permValue === PERMISSIONS.MANAGE_ROLES_PERMISSIONS && role === 'Admin') return;

                    const isChecked = serverRolePermissionsConfig[role] && serverRolePermissionsConfig[role][permValue];
                    html += `
                        <label class="flex items-center space-x-2 text-sm">
                            <input type="checkbox" id="perm-${role}-${permValue}" data-role="${role}" data-permission="${permValue}" 
                                class="form-checkbox h-4 w-4 text-blue-500 bg-gray-600 border-gray-500 rounded focus:ring-blue-400" 
                                ${isChecked ? 'checked' : ''}>
                            <span>${permissionLabels[permValue] || permValue}</span>
                        </label>
                    `;
                });
                html += `</div></div>`;
            });
            html += '</div>';
            adminPermissionsSettings.innerHTML = html;
        }

        async function saveRolePermissions() {
            if (!hasPermission(PERMISSIONS.MANAGE_ROLES_PERMISSIONS)) {
                showModal("Você não tem permissão para gerenciar permissões.", "error"); return;
            }

            const newPermissionsConfig = JSON.parse(JSON.stringify(serverRolePermissionsConfig)); 

            defaultRoles.forEach(role => {
                if (role === 'Admin') { 
                    newPermissionsConfig[role] = {};
                    Object.values(PERMISSIONS).forEach(permValue => {
                        newPermissionsConfig[role][permValue] = true;
                    });
                    return; 
                }
                
                if (!newPermissionsConfig[role]) newPermissionsConfig[role] = {}; 
                
                Object.values(PERMISSIONS).forEach(permValue => {
                    const checkbox = document.getElementById(`perm-${role}-${permValue}`);
                    if (checkbox) { 
                        newPermissionsConfig[role][permValue] = checkbox.checked;
                    } 
                });
            });

            try {
                await setDoc(serverConfigDocRef, { rolePermissions: newPermissionsConfig }, { merge: true });
                showModal("Permissões dos cargos salvas com sucesso!", "success");
            } catch (error) {
                console.error("Error saving role permissions:", error);
                showModal("Erro ao salvar permissões: " + error.message, "error");
            }
        }


        // --- Modal & Confirmation ---
        const messageModal = document.getElementById('message-modal');
        const messageModalText = document.getElementById('message-modal-text');
        const messageModalClose = document.getElementById('message-modal-close');

        function showModal(message, type = "info") { 
            if (!messageModal || !messageModalText) {
                console.warn("Message modal elements not found. Message:", message);
                if (type === "error") console.error(message);
                else if (type === "success") console.log("SUCCESS:", message);
                else console.info(message);
                return;
            }
            messageModalText.textContent = message;
            messageModalText.className = 'mb-4 '; 
            if (type === "error") messageModalText.classList.add('text-red-700');
            else if (type === "success") messageModalText.classList.add('text-green-700');
            else messageModalText.classList.add('text-blue-700'); 
            messageModal.style.display = 'flex';
        }
        if (messageModalClose) messageModalClose.onclick = () => messageModal.style.display = 'none';
        
        window.onclick = (event) => { 
            if (event.target == messageModal) messageModal.style.display = 'none';
            
            const createTopicModalElem = document.getElementById('create-topic-modal');
            if (createTopicModalElem && event.target == createTopicModalElem) createTopicModalElem.style.display = 'none';
            
            const confirmActionModalElem = document.getElementById('confirm-action-modal');
            if (confirmActionModalElem && event.target == confirmActionModalElem) confirmActionModalElem.style.display = 'none';
            
            if (csServerModal && event.target == csServerModal) csServerModal.style.display = 'none';
            if (editPostModal && event.target == editPostModal) editPostModal.style.display = 'none';
            if (editTopicModal && event.target == editTopicModal) editTopicModal.style.display = 'none';
        }

        const confirmModal = document.getElementById('confirm-action-modal');
        const confirmModalText = document.getElementById('confirm-action-text');
        const confirmModalYes = document.getElementById('confirm-action-yes');
        const confirmModalNo = document.getElementById('confirm-action-no');
        let confirmCallback = null;

        function confirmAction(message, callback) {
            if (!confirmModal || !confirmModalText) {
                console.warn("Confirm modal elements not found. Action:", message);
                console.error("Confirmation modal not available for: " + message + ". Action NOT performed.");
                return;
            }
            confirmModalText.textContent = message;
            confirmCallback = callback;
            confirmModal.style.display = 'flex';
        }
        if (confirmModalYes) confirmModalYes.onclick = () => {
            if (confirmCallback) confirmCallback();
            confirmModal.style.display = 'none';
            confirmCallback = null;
        };
        if (confirmModalNo) confirmModalNo.onclick = () => {
            confirmModal.style.display = 'none';
            confirmCallback = null;
        };

    </script>

    <header class="bg-gray-800 shadow-md p-4">
        <div class="container mx-auto flex flex-col sm:flex-row justify-between items-center">
            <h1 id="forum-title-header" class="text-3xl font-bold text-blue-500 mb-2 sm:mb-0">Negativa Server - Fórum</h1>
            <nav class="space-x-2 sm:space-x-4 text-sm sm:text-base">
                <span id="user-display" class="text-sm"></span>
                <span id="current-user-id-display" class="text-xs text-gray-400" style="display:none;"></span>
                <a href="#" id="admin-panel-nav" class="text-yellow-400 hover:text-yellow-300" style="display:none;">Painel Admin</a>
                <a href="#" id="my-profile-nav" class="text-blue-400 hover:text-blue-300" style="display:none;">Meu Perfil</a>
                <a href="#" id="login-nav" class="text-blue-400 hover:text-blue-300">Login</a>
                <a href="#" id="register-nav" class="text-blue-400 hover:text-blue-300" style="display:none;">Registrar</a>
                <a href="#" id="logout-nav" class="text-blue-400 hover:text-blue-300" style="display:none;">Logout</a>
            </nav>
        </div>
        <div id="breadcrumbs" class="container mx-auto text-sm text-gray-400 mt-2 px-4 sm:px-0">
            <a href="#" data-view="forumHome" class="hover:text-blue-300">Início</a>
        </div>
    </header>

    <div id="server-info-banner-container" class="container mx-auto mt-4 space-y-2">
    </div>


    <main id="main-content" class="container mx-auto p-4">
        <div id="loading-view" class="view active-view text-center py-10">
            <div class="loading-spinner"></div>
            <p class="text-xl text-gray-300">Carregando...</p>
        </div>

        <div id="login-view" class="view max-w-md mx-auto bg-gray-800 p-8 rounded-lg shadow-xl">
            <h2 class="text-2xl font-semibold mb-6 text-center text-blue-400">Login</h2>
            <form id="login-form">
                <div class="mb-4">
                    <label for="login-email" class="block text-sm font-medium text-gray-300 mb-1">Email</label>
                    <input type="email" id="login-email" name="email" required class="w-full p-3 bg-gray-700 border border-gray-600 rounded-md focus:ring-blue-500 focus:border-blue-500 text-gray-100 placeholder-gray-400" placeholder="seu@email.com">
                </div>
                <div class="mb-6">
                    <label for="login-password" class="block text-sm font-medium text-gray-300 mb-1">Senha</label>
                    <input type="password" id="login-password" name="password" required class="w-full p-3 bg-gray-700 border border-gray-600 rounded-md focus:ring-blue-500 focus:border-blue-500 text-gray-100" placeholder="********">
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-md transition duration-150">Entrar</button>
            </form>
            <p class="text-center mt-4 text-sm">Não tem uma conta? <a href="#" id="show-register-view" class="text-blue-400 hover:underline">Registre-se</a></p>
        </div>

        <div id="register-view" class="view max-w-md mx-auto bg-gray-800 p-8 rounded-lg shadow-xl">
            <h2 class="text-2xl font-semibold mb-6 text-center text-blue-400">Registrar Nova Conta</h2>
            <form id="register-form">
                <div class="mb-4">
                    <label for="register-email" class="block text-sm font-medium text-gray-300 mb-1">Email</label>
                    <input type="email" id="register-email" name="email" required class="w-full p-3 bg-gray-700 border border-gray-600 rounded-md focus:ring-blue-500 focus:border-blue-500 text-gray-100 placeholder-gray-400" placeholder="seu@email.com">
                </div>
                <div class="mb-4">
                    <label for="register-password" class="block text-sm font-medium text-gray-300 mb-1">Senha</label>
                    <input type="password" id="register-password" name="password" required class="w-full p-3 bg-gray-700 border border-gray-600 rounded-md focus:ring-blue-500 focus:border-blue-500 text-gray-100" placeholder="********">
                </div>
                <div class="mb-6">
                    <label for="register-confirmPassword" class="block text-sm font-medium text-gray-300 mb-1">Confirmar Senha</label>
                    <input type="password" id="register-confirmPassword" name="confirmPassword" required class="w-full p-3 bg-gray-700 border border-gray-600 rounded-md focus:ring-blue-500 focus:border-blue-500 text-gray-100" placeholder="********">
                </div>
                <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-4 rounded-md transition duration-150">Registrar</button>
            </form>
            <p class="text-center mt-4 text-sm">Já tem uma conta? <a href="#" id="show-login-view" class="text-blue-400 hover:underline">Faça Login</a></p>
        </div>

        <div id="forum-home-view" class="view">
            <div id="admin-controls" class="mb-6 bg-gray-800 p-6 rounded-lg shadow-md">
                <h3 class="text-2xl font-bold mb-6 text-yellow-500 border-b border-gray-700 pb-3">Painel do Administrador</h3>
                
                <div class="admin-section">
                    <h4 class="admin-section-title">Configurações Gerais do Fórum</h4>
                    <div class="space-y-4">
                        <div>
                            <label for="admin-forum-name" class="block text-sm font-medium text-gray-300 mb-1">Nome do Fórum</label>
                            <input type="text" id="admin-forum-name" class="w-full p-2 bg-gray-600 border border-gray-500 rounded-md text-gray-100 placeholder-gray-400">
                        </div>
                         <div class="flex items-center">
                            <label for="admin-registrations-toggle" class="block text-sm font-medium text-gray-300 mr-3">Permitir Novos Cadastros:</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="admin-registrations-toggle">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="flex space-x-3">
                            <button id="save-forum-name-btn" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-3 rounded-md transition duration-150">Salvar Nome</button>
                            <button id="save-registration-settings-btn" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-3 rounded-md transition duration-150">Salvar Config. Cadastro</button>
                        </div>
                    </div>
                </div>

                <div class="admin-section">
                    <h4 class="admin-section-title">Criar Nova Categoria</h4>
                    <form id="create-category-form" class="space-y-4">
                        <div>
                            <label for="category-name" class="block text-sm font-medium text-gray-300 mb-1">Nome da Categoria</label>
                            <input type="text" id="category-name" name="name" required class="w-full p-3 bg-gray-700 border border-gray-600 rounded-md focus:ring-blue-500 focus:border-blue-500 text-gray-100 placeholder-gray-400">
                        </div>
                        <div class="mb-2">
                            <label for="category-description" class="block text-sm font-medium text-gray-300 mb-1">Descrição</label>
                            <textarea id="category-description" name="description" rows="2" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-md focus:ring-blue-500 focus:border-blue-500 text-gray-100 placeholder-gray-400"></textarea>
                        </div>
                        <div id="category-role-permissions-admin-container" class="mt-2 mb-2">
                            <label class="block text-sm font-medium text-gray-300 mb-1">Permitir visualização para os cargos (deixe desmarcado para público):</label>
                            <div class="space-y-1 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2">
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button type="submit" class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-semibold py-2 px-4 rounded-md transition duration-150">Criar Categoria</button>
                            <button type="button" id="generate-category-description-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-3 rounded-md transition duration-150 text-sm">
                                Gerar Descrição com IA ✨
                            </button>
                            <div id="generate-category-desc-spinner" class="gemini-loading-spinner" style="display:none;"></div>
                        </div>
                    </form>
                </div>

                <div class="admin-section">
                    <h4 class="admin-section-title">Configurar Servidores CS2</h4>
                    <div id="cs-servers-list-admin" class="space-y-2 mb-3">
                    </div>
                    <button id="add-cs-server-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-3 rounded-md transition duration-150">Adicionar Servidor CS2</button>
                </div>

                <div class="admin-section">
                    <h4 class="admin-section-title">Configurações de Cores dos Cargos</h4>
                    <div id="admin-role-color-settings" class="space-y-2">
                    </div>
                    <button id="save-role-colors-btn" class="mt-3 bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-3 rounded-md transition duration-150">Salvar Cores dos Cargos</button>
                </div>
                
                <div class="admin-section">
                    <h4 class="admin-section-title">Permissões dos Cargos</h4>
                    <div id="admin-permissions-settings" class="space-y-4">
                    </div>
                    <button id="save-permissions-btn" class="mt-3 bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-3 rounded-md transition duration-150">Salvar Permissões</button>
                </div>

                <div class="admin-section">
                    <h4 class="admin-section-title">Gerenciamento de Usuários</h4>
                    <div id="admin-user-list" class="space-y-3 max-h-96 overflow-y-auto">
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="md:col-span-3">
                    <h2 class="text-2xl font-semibold mb-6 text-blue-400">Categorias</h2>
                    <div id="categories-list" class="space-y-4">
                    </div>
                </div>
                <aside class="md:col-span-1 bg-gray-800 p-4 rounded-lg shadow-md">
                    <div id="recent-members-list">
                        <p class="text-gray-400">Carregando membros recentes...</p>
                    </div>
                    <div class="mt-6 pt-4 border-t border-gray-700">
                        <h4 class="text-md font-semibold text-gray-300 mb-2">Chat Rápido</h4>
                        <div id="chat-messages" class="bg-gray-700 p-2 rounded h-48 overflow-y-auto text-xs mb-2">
                        </div>
                        <div class="flex">
                            <input type="text" id="chat-message-input" class="flex-grow p-2 bg-gray-600 border border-gray-500 rounded-l-md text-gray-100 placeholder-gray-400 text-sm" placeholder="Digite sua mensagem...">
                            <button id="send-chat-message-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-3 rounded-r-md text-sm">Enviar</button>
                        </div>
                    </div>
                </aside>
            </div>
        </div>

        <div id="category-view" class="view">
            <div class="flex justify-between items-center mb-6">
                <h2 id="category-title" class="text-2xl font-semibold text-blue-400"></h2>
                <button id="show-create-topic-modal" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-md transition duration-150">Novo Tópico</button>
            </div>
            <div id="topics-list" class="space-y-3">
            </div>
        </div>

        <div id="topic-view" class="view">
            <h2 id="topic-title-full" class="text-2xl font-semibold mb-6 text-blue-400"></h2>
            <div id="topic-poll-container" class="mb-6">
            </div>
            <div id="posts-list" class="mb-6">
            </div>
            <form id="create-post-form" class="bg-gray-800 p-6 rounded-lg shadow-md">
                <h3 class="text-xl font-semibold mb-4 text-gray-200">Responder ao Tópico</h3>
                <div>
                    <label for="post-content" class="block text-sm font-medium text-gray-300 mb-1">Sua Mensagem</label>
                    <textarea id="post-content" name="content" rows="5" required class="w-full p-3 bg-gray-700 border border-gray-600 rounded-md focus:ring-blue-500 focus:border-blue-500 text-gray-100 placeholder-gray-400"></textarea>
                </div>
                <button type="submit" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md transition duration-150">Enviar Resposta</button>
            </form>
        </div>

        <div id="my-profile-view" class="view max-w-lg mx-auto bg-gray-800 p-8 rounded-lg shadow-xl">
            <h2 class="text-2xl font-semibold mb-6 text-center text-blue-400">Meu Perfil</h2>
            <div class="mb-4">
                <label for="my-profile-nickname" class="block text-sm font-medium text-gray-300 mb-1">Nickname (Apelido)</label>
                <input type="text" id="my-profile-nickname" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-md text-gray-100 placeholder-gray-400">
            </div>
            <div class="mb-4">
                <label for="my-profile-steam-url" class="block text-sm font-medium text-gray-300 mb-1">URL do Perfil Steam (Opcional)</label>
                <input type="url" id="my-profile-steam-url" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-md text-gray-100 placeholder-gray-400" placeholder="https://steamcommunity.com/id/seu_id_ou_profile/123...">
            </div>
            <div class="mb-4">
                <p class="text-sm text-gray-400">Email: <span id="my-profile-email" class="text-gray-200"></span></p>
            </div>
            <div class="mb-6">
                <p class="text-sm text-gray-400">Cargo: <span id="my-profile-role" class="text-gray-200"></span></p>
            </div>
            <button id="my-profile-save-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-4 rounded-md transition duration-150">Salvar Alterações</button>
        </div>

        <div id="user-profile-view" class="view max-w-lg mx-auto bg-gray-800 p-8 rounded-lg shadow-xl">
            <h2 class="text-2xl font-semibold mb-6 text-center text-blue-400">Perfil de Usuário</h2>
            <div class="space-y-3">
                <p><strong class="text-gray-400">Nome de Exibição:</strong> <span id="user-profile-view-displayName" class="text-gray-200"></span></p>
                <p><strong class="text-gray-400">Nickname:</strong> <span id="user-profile-view-nickname" class="text-gray-200"></span></p>
                <p><strong class="text-gray-400">Email:</strong> <span id="user-profile-view-email" class="text-gray-200"></span></p>
                <p><strong class="text-gray-400">Cargo:</strong> <span id="user-profile-view-role" class="text-gray-200"></span></p>
                <p style="display:none;"><strong class="text-gray-400">Perfil Steam:</strong> <a id="user-profile-view-steam-link" href="#" target="_blank" class="text-blue-400 hover:underline"></a></p>
                <p><strong class="text-gray-400">Registrado em:</strong> <span id="user-profile-view-registered-date" class="text-gray-200"></span></p>
            </div>
            <button id="back-to-forum-from-profile" class="mt-6 w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-3 rounded-md transition duration-150">Voltar ao Fórum</button>
        </div>


    </main>

    <footer class="bg-gray-800 text-center p-4 mt-8">
        <p class="text-sm text-gray-500">&copy; Negativa Server. Todos os direitos reservados.</p>
    </footer>

    <div id="message-modal" class="modal" style="display:none;">
        <div class="modal-content bg-gray-100 text-gray-800 rounded-lg shadow-xl">
            <span id="message-modal-close" class="modal-close">&times;</span>
            <p id="message-modal-text" class="mb-4"></p>
            <button onclick="document.getElementById('message-modal').style.display='none'" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded w-full">OK</button>
        </div>
    </div>

    <div id="create-topic-modal" class="modal" style="display:none;">
        <div class="modal-content modal-content-lg bg-gray-800 text-gray-100 p-6 rounded-lg shadow-xl w-full">
            <h3 class="text-xl font-semibold mb-4 text-blue-400">Criar Novo Tópico</h3>
            <form id="create-topic-form-modal">
                <div class="mb-4">
                    <label for="new-topic-title" class="block text-sm font-medium text-gray-300 mb-1">Título do Tópico</label>
                    <input type="text" id="new-topic-title" name="title" required class="w-full p-3 bg-gray-700 border border-gray-600 rounded-md focus:ring-blue-500 focus:border-blue-500 text-gray-100 placeholder-gray-400">
                </div>
                <div class="mb-4">
                    <label for="new-topic-content" class="block text-sm font-medium text-gray-300 mb-1">Conteúdo da Primeira Postagem</label>
                    <textarea id="new-topic-content" name="content" rows="5" required class="w-full p-3 bg-gray-700 border border-gray-600 rounded-md focus:ring-blue-500 focus:border-blue-500 text-gray-100 placeholder-gray-400"></textarea>
                </div>
                <div class="mb-4">
                    <label for="new-topic-command" class="block text-sm font-medium text-gray-300 mb-1">Comando para Copiar (Opcional)</label>
                    <input type="text" id="new-topic-command" name="commandToCopy" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-md text-gray-100 placeholder-gray-400" placeholder="Ex: connect seu.ip.aqui:porta">
                </div>
                <div id="topic-role-permissions-container" class="mb-4">
                    <label class="block text-sm font-medium text-gray-300 mb-1">Permitir visualização para os cargos (deixe desmarcado para herdar da categoria/público):</label>
                    <div class="space-y-1 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2">
                        </div>
                </div>

                <div class="flex justify-end space-x-3 items-center">
                    <button type="button" id="suggest-topic-title-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-3 rounded-md transition duration-150 text-sm">
                        Sugerir Título com IA ✨
                    </button>
                    <div id="suggest-topic-title-spinner" class="gemini-loading-spinner" style="display:none;"></div>
                    <button type="button" id="cancel-create-topic" class="bg-gray-600 hover:bg-gray-500 text-white font-semibold py-2 px-4 rounded-md transition duration-150">Cancelar</button>
                    <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-md transition duration-150">Criar Tópico</button>
                </div>
            </form>
        </div>
    </div>

    <div id="edit-topic-modal" class="modal" style="display:none;">
        <div class="modal-content modal-content-lg bg-gray-800 text-gray-100 p-6 rounded-lg shadow-xl w-full">
            <h3 class="text-xl font-semibold mb-4 text-blue-400">Editar Tópico</h3>
            <form id="edit-topic-form-modal">
                <div class="mb-4">
                    <label for="edit-topic-title" class="block text-sm font-medium text-gray-300 mb-1">Título do Tópico</label>
                    <input type="text" id="edit-topic-title" name="title" required class="w-full p-3 bg-gray-700 border border-gray-600 rounded-md focus:ring-blue-500 focus:border-blue-500 text-gray-100 placeholder-gray-400">
                </div>
                <div id="edit-topic-role-permissions-container" class="mb-4">
                    <label class="block text-sm font-medium text-gray-300 mb-1">Permitir visualização para os cargos (deixe desmarcado para herdar da categoria/público):</label>
                    <div class="space-y-1 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2">
                        </div>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancel-edit-topic-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-semibold py-2 px-4 rounded-md">Cancelar</button>
                    <button type="button" id="save-edit-topic-btn" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-md">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="confirm-action-modal" class="modal" style="display:none;">
        <div class="modal-content bg-gray-100 text-gray-800 p-6 rounded-lg shadow-xl w-full max-w-md">
            <h3 class="text-lg font-semibold mb-4 text-yellow-500">Confirmar Ação</h3>
            <p id="confirm-action-text" class="mb-6 text-gray-700"></p>
            <div class="flex justify-end space-x-3">
                <button id="confirm-action-no" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-md transition duration-150">Não</button>
                <button id="confirm-action-yes" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-md transition duration-150">Sim</button>
            </div>
        </div>
    </div>

    <div id="cs-server-modal" class="modal" style="display:none;">
        <div class="modal-content bg-gray-800 text-gray-100 p-6 rounded-lg shadow-xl w-full max-w-lg">
            <h3 class="text-xl font-semibold mb-4 text-blue-400">Configurar Servidor CS2</h3>
            <form id="cs-server-form">
                <input type="hidden" id="cs-server-id">
                <div class="mb-4">
                    <label for="cs-server-name" class="block text-sm font-medium text-gray-300 mb-1">Nome de Exibição do Servidor</label>
                    <input type="text" id="cs-server-name" required class="w-full p-2 bg-gray-700 border border-gray-600 rounded-md text-gray-100 placeholder-gray-400">
                </div>
                <div class="mb-4">
                    <label for="cs-server-connect" class="block text-sm font-medium text-gray-300 mb-1">Comando de Conexão (ex: connect 127.0.0.1:27015)</label>
                    <input type="text" id="cs-server-connect" required class="w-full p-2 bg-gray-700 border border-gray-600 rounded-md text-gray-100 placeholder-gray-400">
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancel-cs-server" class="bg-gray-600 hover:bg-gray-500 text-white font-semibold py-2 px-4 rounded-md">Cancelar</button>
                    <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-md">Salvar Servidor</button>
                </div>
            </form>
        </div>
    </div>

    <div id="edit-post-modal" class="modal" style="display:none;">
        <div class="modal-content bg-gray-800 text-gray-100 p-6 rounded-lg shadow-xl w-full max-w-lg">
            <h3 class="text-xl font-semibold mb-4 text-blue-400">Editar Postagem</h3>
            <textarea id="edit-post-content" rows="8" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-md text-gray-100 placeholder-gray-400 mb-4"></textarea>
            <div class="flex justify-end space-x-3">
                <button type="button" id="cancel-edit-post-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-semibold py-2 px-4 rounded-md">Cancelar</button>
                <button type="button" id="save-edit-post-btn" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-md">Salvar Edição</button>
            </div>
        </div>
    </div>

</body>
</html>
